#Attempt to Get Revenue in R
install.packages("readxl")
install.packages("tidyr")
install.packages("dplyr")
install.packages("did")
install.packages("tidyverse")
install.packages("lmtest")
library(readxl)
library(tidyr)
library(dplyr)
library(did)
library(tidyverse)
library(lmtest)
Census State and Local Data- Tax Foundation
# Census State and Local Data- Tax Foundation
install.packages("readxl")
install.packages("tidyr")
install.packages("dplyr")
install.packages("tidyverse")
install.packages("xlsx")
library(readxl)
library(tidyr)
library(dplyr)
library(tidyverse)
library(xlsx)
#Nebraska or "Direct Switchers DiD Approach"
#Run DiD with all the Direct Switchers (NE, MO, MS, CO, RI, ND, DE)
#Control Group is all States that Did not Switch by 2007.
#this includes: AK, HI, KS, NM, OK.  AL and MT between 2008-now became "Step
#-wise" switchers.  FL and MA had DWS over the whole period 1976-2022.
library(tidyr)
library(dplyr)
library(tidyverse)
# for robust standard error estimation
library(lmtest)
# To calculate correct vcov matrix with 2WFE
library(multiwayvcov)
# For a package way to do FE
library(plm)
#Fixest
install.packages("fixest")
library(fixest)
#Load Data Tables in R
install.packages("data.table")
# Get rate of change for tax bases and find elasticity of tax base w.r.t apportionment and rate changes.
#Redo Callaway and Sant'Anna From Summer
library(readxl)
library(tidyr)
library(dplyr)
library(did)
library(tidyverse)
library(lmtest)
library(caret)
library(ggplot2)
#New Directory
setwd("~/Documents/GitHub/ST_Apportionment/Rates_Of_Change")
#in a notebook, like Micah recommended.
#Load Packages
library(tidyr)
library(dplyr)
library(tidyverse)
library(lmtest)
library(ggplot2)
library(did) # for running DiD
library(sjlabelled) # req by https://rpubs.com/phle/r_tutorial_difference_in_differences
library(ggrepel) # req by ^
library(scales) # req by ^
library(ggpubr) # req by ^
library(plm)
library(lmtest)
#Load Packages
library(readxl)
#Get Population data from state_tax_files Directory
setwd("~/Documents/GitHub/state_tax_revenues/fred_excel_files_feb_2024")
population <- read.xls("State_Resident_Population.xls",sheet="Annual")
population <- read_xls("State_Resident_Population.xls",sheet="Annual")
View(population)
library(lubridate)
#convert the Date in the census sheet
population2 <- population %>%
mutate(year=year(DATE))
View(population2)
setwd("~/Documents/GitHub/ST-Apportionment/job_market_data")
#Load Revenue panel
Rev <- read.csv("logTotRev_cpi.csv")
View(Rev)
#note, row names =FALSE did not work, still have an X
Rev <- Rev %>%
select(-X)
View(Rev)
# set seed
set.seed(26)
View(population2)
# filter population dataframe to make it easier to use
population3 <- population2 %>%
filter(year>=1976)
View(population3)
str(population3)
#Columns for each state are named "AKPOP" for Alaska population. Want to get just the acronym for each
population4 <- population3 %>%
rename_with(.fn = ~ ifelse(grepl("^[A-Z]{2}POP$", .), substr(., 1, 2), .),
.cols = everything())
View(population4)
str(population4)
str(Rev)
# Pivot population4 to long format to make it easier to join
population4_long <- population4 %>%
pivot_longer(-c(DATE, year), names_to = "State_Acronym", values_to = "population")
View(population4_long)
# Merge with Rev and create the new "population" column
Rev1 <- Rev %>%
left_join(population4_long, by = c("State_Acronym" = "State_Acronym", "year" = "year"))
View(Rev1)
Rev1 <- Rev1 %>%
select(-DATE)
write.csv(Rev1,"rev_population.csv")
View(Rev1)
per_capita <- Rev1 %>%
mutate(Total_capita=logRealTotRev/population) %>%
mutate(CIT_capita=((log(CORPINCTX)/CPI_def)*100)/population)
View(per_capita)
RealCorp <- Rev1 %>%
mutate(real_cit = (CORPINCTX/CPI_def)*100)
View(RealCorp)
View(per_capita)
log_realCorp <- RealCorp %>%
mutate(logRealCitRev=log(real_cit))
per_capita <- log_realCorp %>%
mutate(Total_capita=logRealTotRev/population) %>%
mutate(CIT_capita=logRealCitRev/population)
View(per_capita)
per_capita <- log_realCorp %>%
mutate(Tot_logReal_capita=logRealTotRev/population) %>%
mutate(CIT_logReal_capita=logRealCitRev/population)
real_perCapita <- per_capita %>%
mutate(real_totRev_capita = real_totRev/population)%>%
mutate(real_cit_capita = real_cit/population)
View(real_perCapita)
#plot real per capita
ggplot(real_perCapita, aes(x=real_totRev_capita,y=year))+
geom_point()
#plot real per capita
ggplot(real_perCapita, aes(x=year,y=real_totRev_capita, color=State_Acronym))+
geom_point()
real_perCapita2 <- real_perCapita %>%
mutate(real_totRev_capita_conv = real_totRev_capita*1000)%>%
mutate(real_cit_capita_conv = real_cit_capita*1000)
#plot real per capita
ggplot(real_perCapita2, aes(x=year,y=real_totRev_capita_conv, color=State_Acronym))+
geom_point()
View(real_perCapita2)
#Create a dataframe with just 2007 states
treated_states <- real_perCapita %>%
filter(year_effective==2007)
#create df for control group
control_states <- real_perCapita %>%
filter(year_effective >=2011 | is.na(year_effective))
#Create dataframe with states in control_states
states_1df <- control_states %>%
distinct(State_Acronym)
print(states_1df)
states_2df <- treated_states %>%
distinct(State_Acronym)
print(states_2df)
# find mean of control_States, pre & post
control_pre <-control_states %>%
filter(year <= 2007) %>%
summarize(avg_outcome = mean(logRealTotRev, na.rm= TRUE))
# find mean of control_States, pre & post
control_pre <-control_states %>%
filter(year <= 2007) %>%
summarize(avg_outcome = mean(real_totRev_capita, na.rm= TRUE))
control_post <-control_states %>%
filter(year >2007 & year<2011) %>%
summarize(avg_outcome = mean(real_totRev_capita, na.rm= TRUE))
# calculate averages for treatment group
treatment_pre <- treated_states %>%
filter(year <= 2007) %>%
summarize(avg_outcome = mean(real_totRev_capita, na.rm = TRUE))
treatment_post <- treated_states %>%
filter(year >2007 & year<2011) %>%
summarise(avg_outcome = mean(real_totRev_capita, na.rm = TRUE))
# Calculate differences
control_diff <- control_post$avg_outcome - control_pre$avg_outcome
treatment_diff <- treatment_post$avg_outcome - treatment_pre$avg_outcome
# Calculate Difference-in-Differences
did_estimate <- treatment_diff - control_diff
# Print the DiD estimate
did_estimate
# Calculate average logRealTotRev by year for treated states along with standard error
average_t <- treated_states %>%
group_by(year) %>%
filter(!is.na(logRealTotRev)) %>%
summarise(average_TOTLTX_t = mean(logRealTotRev),
std_err_t = sd(real_totRev_capita) / sqrt(n()))
# Merge the two dataframes by year
average_df <- merge(average_c, average_t, by = "year", all = TRUE)
#Attempt to create plot
# Calculate average Log Total Tax by year for control group along with standard error
average_c <- control_states %>%
group_by(year) %>%
filter(!is.na(real_totRev_capita)) %>%
summarise(average_TOTLTX_c = mean(real_totRev_capita),
std_err_c = sd(logRealTotRev) / sqrt(n()))
# Calculate average real_totRev_capita by year for treated states along with standard error
average_t <- treated_states %>%
group_by(year) %>%
filter(!is.na(real_totRev_capita)) %>%
summarise(average_TOTLTX_t = mean(real_totRev_capita),
std_err_t = sd(real_totRev_capita) / sqrt(n()))
# Merge the two dataframes by year
average_df <- merge(average_c, average_t, by = "year", all = TRUE)
# Create the plot, standard bar plot with standard error bars
ggplot(average_df, aes(x = year)) +
geom_point(aes(y = average_TOTLTX_c, color = "Control Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_c, ymin = average_TOTLTX_c - std_err_c, ymax = average_TOTLTX_c + std_err_c, color = "Control Group"), width = 0.2) +
geom_point(aes(y = average_TOTLTX_t, color = "Treatment Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_t, ymin = average_TOTLTX_t - std_err_t, ymax = average_TOTLTX_t + std_err_t, color = "Treatment Group"), width = 0.2) +
geom_vline(xintercept = 2007, linetype = "dashed", color = "black", size = 1) +
labs(title = "Average Log Real Total Tax Revenue by Year for Control and Treatment Groups",
x = "Year",
y = "Average Log Real Total Tax Revenue") +
scale_color_manual(values = c("Control Group" = "blue", "Treatment Group" = "red"),
labels = c("Control Group" = "Group c", "Treatment Group" = "Group t")) +
guides(color = guide_legend(title = "Groups")) +
theme_minimal()
# Create the plot, standard bar plot with standard error bars
ggplot(average_df, aes(x = year)) +
geom_point(aes(y = average_TOTLTX_c, color = "Control Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_c, ymin = average_TOTLTX_c - std_err_c, ymax = average_TOTLTX_c + std_err_c, color = "Control Group"), width = 0.2) +
geom_point(aes(y = average_TOTLTX_t, color = "Treatment Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_t, ymin = average_TOTLTX_t - std_err_t, ymax = average_TOTLTX_t + std_err_t, color = "Treatment Group"), width = 0.2) +
geom_vline(xintercept = 2007, linetype = "dashed", color = "black", size = 1) +
labs(title = "Average Real Total Tax Revenue per Capita by Year for Control and Treatment Groups",
x = "Year",
y = "Average Real Total Tax Revenue per Capita") +
scale_color_manual(values = c("Control Group" = "blue", "Treatment Group" = "red"),
labels = c("Control Group" = "Group c", "Treatment Group" = "Group t")) +
guides(color = guide_legend(title = "Groups")) +
theme_minimal()
# Now modify the plot to only have years 2004-2010
ggplot(average_df, aes(x = year)) +
geom_point(aes(y = average_TOTLTX_c, color = "Control Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_c, ymin = average_TOTLTX_c - std_err_c, ymax = average_TOTLTX_c + std_err_c, color = "Control Group"), width = 0.2) +
geom_point(aes(y = average_TOTLTX_t, color = "Treatment Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_t, ymin = average_TOTLTX_t - std_err_t, ymax = average_TOTLTX_t + std_err_t, color = "Treatment Group"), width = 0.2) +
geom_vline(xintercept = 2007, linetype = "dashed", color = "black", size = 1) +
labs(title = "Average Real Total Tax Revenue per Capita by Year for Control and Treatment Groups",
x = "Year",
y = "Average Real Total Tax Revenue per Capita") +
scale_color_manual(values = c("Control Group" = "blue", "Treatment Group" = "red"),
labels = c("Control Group" = "Group c", "Treatment Group" = "Group t")) +
guides(color = guide_legend(title = "Groups")) +
xlim(2004, 2010) +
theme_minimal()
View(average_df)
#Attempt to create plot
# Calculate averagereal_totRev_capita by year for control group along with standard error
average_c <- control_states %>%
group_by(year) %>%
filter(!is.na(real_totRev_capita)) %>%
summarise(average_TOTLTX_c = mean(real_totRev_capita),
std_err_c = sd(real_totRev_capita) / sqrt(n()))
# Merge the two dataframes by year
average_df <- merge(average_c, average_t, by = "year", all = TRUE)
# Create the plot, standard bar plot with standard error bars
ggplot(average_df, aes(x = year)) +
geom_point(aes(y = average_TOTLTX_c, color = "Control Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_c, ymin = average_TOTLTX_c - std_err_c, ymax = average_TOTLTX_c + std_err_c, color = "Control Group"), width = 0.2) +
geom_point(aes(y = average_TOTLTX_t, color = "Treatment Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_t, ymin = average_TOTLTX_t - std_err_t, ymax = average_TOTLTX_t + std_err_t, color = "Treatment Group"), width = 0.2) +
geom_vline(xintercept = 2007, linetype = "dashed", color = "black", size = 1) +
labs(title = "Average Real Total Tax Revenue per Capita by Year for Control and Treatment Groups",
x = "Year",
y = "Average Real Total Tax Revenue per Capita") +
scale_color_manual(values = c("Control Group" = "blue", "Treatment Group" = "red"),
labels = c("Control Group" = "Group c", "Treatment Group" = "Group t")) +
guides(color = guide_legend(title = "Groups")) +
theme_minimal()
# Now modify the plot to only have years 2004-2010
ggplot(average_df, aes(x = year)) +
geom_point(aes(y = average_TOTLTX_c, color = "Control Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_c, ymin = average_TOTLTX_c - std_err_c, ymax = average_TOTLTX_c + std_err_c, color = "Control Group"), width = 0.2) +
geom_point(aes(y = average_TOTLTX_t, color = "Treatment Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_t, ymin = average_TOTLTX_t - std_err_t, ymax = average_TOTLTX_t + std_err_t, color = "Treatment Group"), width = 0.2) +
geom_vline(xintercept = 2007, linetype = "dashed", color = "black", size = 1) +
labs(title = "Average Real Total Tax Revenue per Capita by Year for Control and Treatment Groups",
x = "Year",
y = "Average Real Total Tax Revenue per Capita") +
scale_color_manual(values = c("Control Group" = "blue", "Treatment Group" = "red"),
labels = c("Control Group" = "Group c", "Treatment Group" = "Group t")) +
guides(color = guide_legend(title = "Groups")) +
xlim(2004, 2010) +
theme_minimal()
# find mean of control_States, pre & post
control_pre <-control_states %>%
filter(year <= 2007) %>%
summarize(avg_outcome = mean(real_cit_capita, na.rm= TRUE))
control_post <-control_states %>%
filter(year >2007 & year<2011) %>%
summarize(avg_outcome = mean(real_cit_capita, na.rm= TRUE))
# calculate averages for treatment group
treatment_pre <- treated_states %>%
filter(year <= 2007) %>%
summarize(avg_outcome = mean(real_cit_capita, na.rm = TRUE))
treatment_post <- treated_states %>%
filter(year >2007 & year<2011) %>%
summarise(avg_outcome = mean(real_cit_capita, na.rm = TRUE))
# Calculate differences
control_diff <- control_post$avg_outcome - control_pre$avg_outcome
treatment_diff <- treatment_post$avg_outcome - treatment_pre$avg_outcome
# Calculate Difference-in-Differences
did_estimate <- treatment_diff - control_diff
# Print the DiD estimate, CIT per capita estimate
did_estimate
#Attempt to create plot
# Calculate averagereal_totRev_capita by year for control group along with standard error
average_c <- control_states %>%
group_by(year) %>%
filter(!is.na(real_cit_capita)) %>%
summarise(average_TOTLTX_c = mean(real_cit_capita),
std_err_c = sd(real_cit_capita) / sqrt(n()))
# Calculate average real_cit_capita by year for treated states along with standard error
average_t <- treated_states %>%
group_by(year) %>%
filter(!is.na(real_cit_capita)) %>%
summarise(average_TOTLTX_t = mean(real_cit_capita),
std_err_t = sd(real_cit_capita) / sqrt(n()))
# Merge the two dataframes by year
average_df <- merge(average_c, average_t, by = "year", all = TRUE)
# Create the plot, standard bar plot with standard error bars
ggplot(average_df, aes(x = year)) +
geom_point(aes(y = average_TOTLTX_c, color = "Control Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_c, ymin = average_TOTLTX_c - std_err_c, ymax = average_TOTLTX_c + std_err_c, color = "Control Group"), width = 0.2) +
geom_point(aes(y = average_TOTLTX_t, color = "Treatment Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_t, ymin = average_TOTLTX_t - std_err_t, ymax = average_TOTLTX_t + std_err_t, color = "Treatment Group"), width = 0.2) +
geom_vline(xintercept = 2007, linetype = "dashed", color = "black", size = 1) +
labs(title = "Average Real Corporate Tax Revenue per Capita by Year for Control and Treatment Groups",
x = "Year",
y = "Average Real Corporate Revenue per Capita") +
scale_color_manual(values = c("Control Group" = "blue", "Treatment Group" = "red"),
labels = c("Control Group" = "Group c", "Treatment Group" = "Group t")) +
guides(color = guide_legend(title = "Groups")) +
theme_minimal()
# Now modify the plot to only have years 2004-2010
ggplot(average_df, aes(x = year)) +
geom_point(aes(y = average_TOTLTX_c, color = "Control Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_c, ymin = average_TOTLTX_c - std_err_c, ymax = average_TOTLTX_c + std_err_c, color = "Control Group"), width = 0.2) +
geom_point(aes(y = average_TOTLTX_t, color = "Treatment Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_t, ymin = average_TOTLTX_t - std_err_t, ymax = average_TOTLTX_t + std_err_t, color = "Treatment Group"), width = 0.2) +
geom_vline(xintercept = 2007, linetype = "dashed", color = "black", size = 1) +
labs(title = "Average Real CIT Tax Revenue per Capita by Year for Control and Treatment Groups",
x = "Year",
y = "Average Real CIT  Tax Revenue per Capita") +
scale_color_manual(values = c("Control Group" = "blue", "Treatment Group" = "red"),
labels = c("Control Group" = "Group c", "Treatment Group" = "Group t")) +
guides(color = guide_legend(title = "Groups")) +
xlim(2004, 2010) +
theme_minimal()
#Save the dataframe for per_capita
write.csv(real_perCapita,"real_per_capita_df.csv")
