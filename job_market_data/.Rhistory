#Attempt to Get Revenue in R
install.packages("readxl")
install.packages("tidyr")
install.packages("dplyr")
install.packages("did")
install.packages("tidyverse")
install.packages("lmtest")
library(readxl)
library(tidyr)
library(dplyr)
library(did)
library(tidyverse)
library(lmtest)
Census State and Local Data- Tax Foundation
# Census State and Local Data- Tax Foundation
install.packages("readxl")
install.packages("tidyr")
install.packages("dplyr")
install.packages("tidyverse")
install.packages("xlsx")
library(readxl)
library(tidyr)
library(dplyr)
library(tidyverse)
library(xlsx)
#Nebraska or "Direct Switchers DiD Approach"
#Run DiD with all the Direct Switchers (NE, MO, MS, CO, RI, ND, DE)
#Control Group is all States that Did not Switch by 2007.
#this includes: AK, HI, KS, NM, OK.  AL and MT between 2008-now became "Step
#-wise" switchers.  FL and MA had DWS over the whole period 1976-2022.
library(tidyr)
library(dplyr)
library(tidyverse)
# for robust standard error estimation
library(lmtest)
# To calculate correct vcov matrix with 2WFE
library(multiwayvcov)
# For a package way to do FE
library(plm)
#Fixest
install.packages("fixest")
library(fixest)
#Load Data Tables in R
install.packages("data.table")
# Get rate of change for tax bases and find elasticity of tax base w.r.t apportionment and rate changes.
#Redo Callaway and Sant'Anna From Summer
library(readxl)
library(tidyr)
library(dplyr)
library(did)
library(tidyverse)
library(lmtest)
library(caret)
library(ggplot2)
#New Directory
setwd("~/Documents/GitHub/ST_Apportionment/Rates_Of_Change")
#Load Packages
library(tidyr)
library(dplyr)
library(tidyverse)
library(lmtest)
library(ggplot2)
library(readxl) #load ssfa switch date
library(did) # for running DiD
library(caret)
library(plm) # for Two way FE
library(fixest) # multiple FE
library(broom) #extract coefficients for each state
library(coefplot) #Stata coefficient plot, https://cran.r-project.org/web/packages/coefplot/coefplot.pdf
# set seed
set.seed(26)
#JMP Directory
setwd("~/Documents/GitHub/ST-Apportionment/job_market_data")
Rev3 <- read.csv("revenue_cpi_total.csv")
#Run the Two way FE regression again, except, do it with Real Revenue, loaded in Rev 3
Rev4 <- Rev3 %>%
mutate(logRealTotRev=log(real_totRev))
#Simple regression, real revenue
Simple_reg <- lm(logRealTotRev ~ Post + factor(year) + factor(state), Rev4)
summary(Simple_reg)
# Interaction Reg (with interaction between Post and state)
Interaction_Realreg <- lm(logRealTotRev ~ Post * factor(State_Name) + factor(year), data = Rev4)
summary(Interaction_Realreg)
# It is close, just trying to get Alabama
# Set Alabama as the reference category
Rev4$State_Name <- relevel(factor(Rev4$State_Name), ref = "Alabama")
# Interaction Reg (with interaction between Post and state)
Interaction_Realreg2 <- lm(logRealTotRev ~ Post * factor(State_Name) + factor(year), data = Rev4)
summary(Interaction_Realreg2)
#Extract coefficients for each state using Broom
tidy_model <- tidy(Interaction_Realreg2)
# Filter the coefficients to get only those related to Post
post_coefficients <- tidy_model %>%
filter(grepl("Post", term))
print(post_coefficients)
#Extracting the post coefficient for each state
fit_state_model <- function(df) {
lm(logRealTotRev ~ Post + factor(year), data = Rev4)
}
# Split data by state and fit model for each state
state_models <- Rev4 %>%
group_by(State_Name) %>%
group_map(~ fit_state_model(.x))
# Extract coefficients for Post from each model
post_coeffs <- lapply(state_models, function(model) {
tidy(model) %>% filter(term == "Post")
})
# Combine results into a single data frame
post_coeffs_df <- bind_rows(post_coeffs, .id = "State_Name")
print(post_coeffs_df)
#Attempt to dissaggregate the results from the Alabama coefficient
# Set Alabama as the reference category
Rev4$State_Name <- relevel(factor(Rev4$State_Name), ref = "Alabama")
# Interaction regression with interaction between Post and state, more explanation needs to be given for this interaction in github note.
interaction_model <- lm(logRealTotRev ~ Post * factor(State_Name) + factor(year), data = Rev4)
summary(interaction_model)
# Extract coefficients for each state using Broom
tidy_interaction_model <- tidy(interaction_model)
# Filter the coefficients to get only those related to Post
post_interaction_coefficients <- tidy_interaction_model %>%
filter(grepl("Post", term))
print(post_interaction_coefficients)
# Create a data frame for the Post coefficients for each state
post_coefficients_combined <- post_interaction_coefficients %>%
mutate(
State = ifelse(term == "Post", "Alabama", gsub("Post:factor\\(State_Name\\)", "", term)),
Post_Estimate = ifelse(term == "Post", estimate, estimate + post_interaction_coefficients$estimate[post_interaction_coefficients$term == "Post"]),
Post_Std_Error = std.error,
Post_Statistic = statistic,
Post_P_Value = p.value
) %>%
select(State, Post_Estimate, Post_Std_Error, Post_Statistic, Post_P_Value)
post_coefficients_combined %>%
ggplot(aes(x = Post_Estimate, y = State)) +
geom_point() +
geom_vline(xintercept = 0, lty = 2) +
labs(x= "Value", y= "Coefficient", title= "Coefficient Plot for Policy by State") +
theme_minimal()
#Filter out NA states
na_states <- post_coefficients_combined %>%
filter(is.na(Post_Estimate)) %>%
pull(State)
#Create filtered DF
filtered_data <- post_coefficients_combined %>%
filter(!is.na(Post_Estimate))
plot <- ggplot(filtered_data, aes(x = Post_Estimate, y = State)) +
geom_point() +
geom_vline(xintercept = 0, lty = 2) +
labs(x = "Value", y = "Coefficient", title = "Coefficient Plot for Policy by State") +
theme_minimal()
plot <- ggplot(filtered_data, aes(x = Post_Estimate, y = State)) +
geom_point() +
geom_vline(xintercept = 0, lty = 2) +
labs(x = "Value", y = "Coefficient", title = "Coefficient Plot for Policy by State") +
theme_minimal()
#Load Packages
library(tidyr)
library(dplyr)
library(tidyverse)
library(lmtest)
library(ggplot2)
library(readxl) #load ssfa switch date
library(did) # for running DiD
library(caret)
library(plm) # for Two way FE
library(fixest) # multiple FE
library(broom) #extract coefficients for each state
library(coefplot) #Stat
set.seed(26)
#JMP Directory
setwd("~/Documents/GitHub/ST-Apportionment/job_market_data")
View(Rev3)
post_coefficients_combined %>%
ggplot(aes(x = Post_Estimate, y = State)) +
geom_point() +
geom_vline(xintercept = 0, lty = 2) +
labs(x= "Value", y= "Coefficient", title= "Coefficient Plot for Policy by State") +
theme_minimal()
#Plot without NA states
plot <- ggplot(filtered_data, aes(x = Post_Estimate, y = State)) +
geom_point() +
geom_vline(xintercept = 0, lty = 2) +
labs(x = "Value", y = "Coefficient", title = "Coefficient Plot for Policy by State") +
theme_minimal()
# Add footnote
footnote <- paste("States with NA estimates:", paste(na_states, collapse = ", "))
plot <- plot + annotation_custom(
grob = textGrob(footnote, x = 0, y = 0, hjust = -0.1, vjust = -0.1, gp = gpar(fontsize = 10, col = "blue")),
xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf
)
print(plot)
install.packages("grid")
install.packages("grid")
install.packages("grid")
install.packages("grid")
library(grid)
# Add footnote
footnote <- paste("States with NA estimates:", paste(na_states, collapse = ", "))
plot <- plot + annotation_custom(
grob = textGrob(footnote, x = 0, y = 0, hjust = -0.1, vjust = -0.1, gp = gpar(fontsize = 10, col = "blue")),
xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf
)
print(plot)
plot <- ggplot(filtered_data, aes(x = Post_Estimate, y = State)) +
geom_point() +
geom_vline(xintercept = 0, lty = 2) +
labs(x = "Value", y = "Coefficient", title = "Coefficient Plot for Policy by State- No NA States") +
theme_minimal()
library(tidyr)
library(dplyr)
library(tidyverse)
library(lmtest)
library(ggplot2)
library(readxl) #load ssfa switch date
library(did) # for running DiD
library(caret)
library(plm) # for Two way FE
library(fixest) # multiple FE
library(broom) #extract coefficients for each state
library(coefplot)
plot <- ggplot(filtered_data, aes(x = Post_Estimate, y = State)) +
geom_point() +
geom_vline(xintercept = 0, lty = 2) +
labs(x = "Value", y = "Coefficient", title = "Coefficient Plot for Policy by State- No NA States") +
theme_minimal()
# Add footnote
footnote <- paste("States with NA estimates:", paste(na_states, collapse = ", "))
plot <- plot + annotation_custom(
grob = textGrob(footnote, x = 0, y = 0, hjust = -0.1, vjust = -0.1, gp = gpar(fontsize = 10, col = "blue")),
xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf
)
print(plot)
#Plot without NA states
plot <- ggplot(filtered_data, aes(x = Post_Estimate, y = State)) +
geom_point() +
geom_vline(xintercept = 0, lty = 2) +
labs(x = "Value", y = "Coefficient", title = "Coefficient Plot for Policy by State- No NA States") +
theme_minimal()
print(plot)
View(Rev4)
#save Rev4 sheet
write.csv(Rev4,"logTotRev_cpi.csv",row.names = FALSE)
#save post_interactions_coefficients
write.csv(post_coefficients_combined,"twoWFE_LogTotRev_result.csv",row.names = FALSE)
