syn_state = sum(weighted_ci, na.rm = TRUE))
#print and save sum weight
first_sum_weight <- synthetic_sum$sum_weight[1]
# Append the state name and the first sum_weight value to sum_weight_df
sum_weight_df <- rbind(sum_weight_df, data.frame(State_Name = state_name, First_Sum_Weight = first_sum_weight))
# Combine the synthetic state and actual state data
synthetic_combined <- synthetic_sum %>%
left_join(actual_state_data, by = c("year")) %>%
select(-Weight, -weighted_ci)
# Save the result for the current state in the result list
result_list_syn_state[[state_name]] <- synthetic_combined
}
View(result_list_syn_state)
# PART 3 LOOP JUST CREATES THE SYNTHETIC STATE DF AND SAVES IT.
result_list_syn_state <- list()
# Create an empty dataframe to store the state names and first sum_weight values
sum_weight_df <- data.frame(State_Name = character(), First_Sum_Weight = numeric(), stringsAsFactors = FALSE)
# Loop over each dataframe in result_list_long_run
for (state_name in names(result_list_controls)) {
# Remove "_control" to get the actual state name
treatment_state_name <- sub("_control", "", state_name)
#pull treated df
treated_df <- result_list_controls[[state_name]]
#Create synthetic values for the treated df
synthetic_df <- treated_df %>%
mutate(weighted_ci = real_ci_cap * Weight)
#get just treatment state
actual_state_data <- synthetic_df %>%
filter(State_Name == treatment_state_name)
#create the synthetic treated state
synthetic_sum <- synthetic_df %>%
filter(State_Acronym != state_name) %>%
group_by(year) %>%
summarize(sum_weight = sum(Weight, na.rm = TRUE),
syn_state = sum(weighted_ci, na.rm = TRUE))
#print and save sum weight
first_sum_weight <- synthetic_sum$sum_weight[1]
# Append the state name and the first sum_weight value to sum_weight_df
sum_weight_df <- rbind(sum_weight_df, data.frame(State_Name = state_name, First_Sum_Weight = first_sum_weight))
# Combine the synthetic state and actual state data
synthetic_combined <- synthetic_sum %>%
left_join(actual_state_data, by = c("year")) %>%
select(-Weight, -weighted_ci)
# Save the result for the current state in the result list
result_list_syn_state[[state_name]] <- synthetic_combined
}
View(result_list_syn_state)
View(result_list_syn_state[["Louisiana_control"]])
View(sum_weight_df)
#save the sum_weight_df
write.csv(sum_weight_df,"sDiD_weights_SUMMED_by_state.csv", row.names = FALSE)
# PART 3 LOOP JUST CREATES THE SYNTHETIC STATE DF AND SAVES IT.
result_list_syn_state <- list()
# Create an empty dataframe to store the state names and first sum_weight values
sum_weight_df <- data.frame(State_Name = character(), First_Sum_Weight = numeric(), stringsAsFactors = FALSE)
# Loop over each dataframe in result_list_long_run
for (state_name in names(result_list_controls)) {
# Remove "_control" to get the actual state name
treatment_state_name <- sub("_control", "", state_name)
#pull treated df
treated_df <- result_list_controls[[state_name]]
#Create synthetic values for the treated df
synthetic_df <- treated_df %>%
mutate(weighted_ci = real_ci_cap * Weight)
#get just treatment state
actual_state_data <- synthetic_df %>%
filter(State_Name == treatment_state_name)
#create the synthetic treated state
synthetic_sum <- synthetic_df %>%
filter(State_Acronym != state_name) %>%
group_by(year) %>%
summarize(sum_weight = sum(Weight, na.rm = TRUE),
syn_state = sum(weighted_ci, na.rm = TRUE))
#print and save sum weight
first_sum_weight <- synthetic_sum$sum_weight[1]
# Append the state name and the first sum_weight value to sum_weight_df
sum_weight_df <- rbind(sum_weight_df, data.frame(State_Name = state_name, First_Sum_Weight = first_sum_weight))
# Combine the synthetic state and actual state data
synthetic_combined <- synthetic_sum %>%
left_join(actual_state_data, by = c("year")) %>%
select(-Weight, -weighted_ci)
# Save the result for the current state in the result list
result[[paste0(treatment_state_name, "_synthetic")]] <- synthetic_combined
# Save each dataframe as a CSV file with the desired name format
csv_filename <- paste0("synthetic_", treatment_state_name, ".csv")
write.csv(synthetic_combined, csv_filename, row.names = FALSE)
}
View(result_list_syn_state)
View(result)
# PART 3 LOOP JUST CREATES THE SYNTHETIC STATE DF AND SAVES IT.
result_list_syn_state <- list()
# Create an empty dataframe to store the state names and first sum_weight values
sum_weight_df <- data.frame(State_Name = character(), First_Sum_Weight = numeric(), stringsAsFactors = FALSE)
# Loop over each dataframe in result_list_long_run
for (state_name in names(result_list_controls)) {
# Remove "_control" to get the actual state name
treatment_state_name <- sub("_control", "", state_name)
#pull treated df
treated_df <- result_list_controls[[state_name]]
#Create synthetic values for the treated df
synthetic_df <- treated_df %>%
mutate(weighted_ci = real_ci_cap * Weight)
#get just treatment state
actual_state_data <- synthetic_df %>%
filter(State_Name == treatment_state_name)
#create the synthetic treated state
synthetic_sum <- synthetic_df %>%
filter(State_Acronym != state_name) %>%
group_by(year) %>%
summarize(sum_weight = sum(Weight, na.rm = TRUE),
syn_state = sum(weighted_ci, na.rm = TRUE))
#save sum weight
first_sum_weight <- synthetic_sum$sum_weight[1]
# Append the state name and the first sum_weight value to sum_weight_df
sum_weight_df <- rbind(sum_weight_df, data.frame(State_Name = state_name, First_Sum_Weight = first_sum_weight))
# Combine the synthetic state and actual state data
synthetic_combined <- synthetic_sum %>%
left_join(actual_state_data, by = c("year")) %>%
select(-Weight, -weighted_ci)
# Save the result for the current state in the result list
result_list_syn_state[[paste0(treatment_state_name, "_synthetic")]] <- synthetic_combined
}
#PART 4- create the base year 1976 column, estimate the shift, and create the values
#filter to minimize what's in df ? , could do it.
# Initialize an empty list to store the results
results_percentage <- list()
# Initialize a dataframe to store the optimal shift values for each treatment state
optimal_shifts_df <- data.frame(State_Name = character(), Optimal_Shift = numeric(), stringsAsFactors = FALSE)
# Loop through each synthetic state in result_list_syn_state
for (state_name in names(result_list_syn_state)) {
# Pull the treated dataframe for the current state
syn_state <- result_list_syn_state[[state_name]]
# Dynamically create the synthetic column name (e.g., syn_Iowa becomes syn_StateName)
synthetic_col <- paste0("syn_", gsub("_synthetic", "", state_name))
# Create base year 1976 plot
base76_state <- syn_state %>%
group_by(State_Acronym) %>%
mutate(
real_ci_cap_76 = (real_ci_cap / real_ci_cap[year == 1976]) * 100,
syn_state_76 = (.data[[synthetic_col]] / .data[[synthetic_col]][year == 1976]) * 100  # Use dynamic column
) %>%
ungroup()
# Create the shift
diff_base76 <- base76_state %>%
group_by(State_Acronym) %>%
mutate(diff = abs(real_ci_cap_76 - syn_state_76)) %>%
ungroup()
# Objective function for optimization
objective_function <- function(shift) {
# Filter the data where Post == 0
filtered_data <- base76_state[base76_state$Post == 0, ]
# Calculate the absolute difference with the shift applied
difference <- abs(filtered_data$real_ci_cap_76 - (filtered_data$syn_state_76 + shift))
# Calculate the average difference
average_difference <- mean(difference)
return(average_difference)
}
# Use optim to find the shift that minimizes the average absolute difference
initial_guess <- 0  # Start with an initial guess for shift
result <- optim(par = initial_guess, fn = objective_function, method = "Brent", lower = -100, upper = 100)
# Get the optimal shift value
optimal_shift <- result$par
# Save the optimal shift in the dataframe
optimal_shifts_df <- rbind(optimal_shifts_df, data.frame(State_Name = gsub("_synthetic", "", state_name), Optimal_Shift = optimal_shift))
# Mutate the dataframe to apply the shift
shift_base_76 <- base76_state %>%
mutate(syn_state_76_shift = syn_state_76 + optimal_shift)
# Save the dataframe as CSV with the appropriate name
csv_filename <- paste0(gsub("_synthetic", "", state_name), "_base76_shift.csv")
write.csv(shift_base_76, csv_filename, row.names = FALSE)
# Save the shifted dataframe in the results list for further use
results_percentage[[paste0(state_name, "_shift")]] <- shift_base_76
}
View(result_list_syn_state)
View(result_list_syn_state[["Iowa_synthetic"]])
# Loop through each synthetic state in result_list_syn_state
for (state_name in names(result_list_syn_state)) {
# Pull the treated dataframe for the current state
syn_state <- result_list_syn_state[[state_name]]
# Create base year 1976 plot
base76_state <- syn_state %>%
group_by(State_Acronym) %>%
mutate(
real_ci_cap_76 = (real_ci_cap / real_ci_cap[year == 1976]) * 100,
syn_state_76 = (syn_state / syn_state[year == 1976]) * 100  # Using syn_state now
) %>%
ungroup()
# Create the shift
diff_base76 <- base76_state %>%
group_by(State_Acronym) %>%
mutate(diff = abs(real_ci_cap_76 - syn_state_76)) %>%
ungroup()
# Objective function for optimization
objective_function <- function(shift) {
# Filter the data where Post == 0
filtered_data <- base76_state[base76_state$Post == 0, ]
# Calculate the absolute difference with the shift applied
difference <- abs(filtered_data$real_ci_cap_76 - (filtered_data$syn_state_76 + shift))
# Calculate the average difference
average_difference <- mean(difference)
return(average_difference)
}
# Use optim to find the shift that minimizes the average absolute difference
initial_guess <- 0  # Start with an initial guess for shift
result <- optim(par = initial_guess, fn = objective_function, method = "Brent", lower = -100, upper = 100)
# Get the optimal shift value
optimal_shift <- result$par
# Save the optimal shift in the dataframe
optimal_shifts_df <- rbind(optimal_shifts_df, data.frame(State_Name = gsub("_synthetic", "", state_name), Optimal_Shift = optimal_shift))
# Mutate the dataframe to apply the shift
shift_base_76 <- base76_state %>%
mutate(syn_state_76_shift = syn_state_76 + optimal_shift)
# Save the dataframe as CSV with the appropriate name
csv_filename <- paste0(gsub("_synthetic", "", state_name), "_base76_shift.csv")
write.csv(shift_base_76, csv_filename, row.names = FALSE)
# Save the shifted dataframe in the results list for further use
results_percentage[[paste0(state_name, "_shift")]] <- shift_base_76
}
View(results_percentage)
View(optimal_shifts_df)
write.csv(optimal_shifts_df,"optimal_shift_by_state.csv", row.names = FALSE)
View(results_percentage)
View(results_percentage)
View(results_percentage)
# Initialize a list to store the percentage change dataframes for each state
percent_change_revenue <- list()
# Loop through each state's shifted dataframe in results_percentage
for (state_name in names(results_percentage)) {
# Get the shifted dataframe for the current state
shift_state <- results_percentage[[state_name]]
# Pull the year_effective[1] for the current state
year_effective <- shift_state$year_effective[1]
# Define the short-run years (year_effective[1], year_effective[1] + 1, year_effective[1] + 2)
short_run_years <- c(year_effective, year_effective + 1, year_effective + 2)
# Calculate the percentage change for the short run
SR_perc <- shift_state %>%
filter(year %in% short_run_years) %>%
mutate(perc_chan = (real_ci_cap_76 - syn_state_76_shift) / ((real_ci_cap_76 + syn_state_76_shift) / 2)) %>%
summarize(avg_perc_chan_SR = mean(perc_chan, na.rm = TRUE))
# Define the long-run period (you can adjust this as needed)
# Assuming the long-run years are all available years after the short run
LR_perc <- shift_state %>%
filter(year > (year_effective + 2)) %>%
mutate(perc_chan = (real_ci_cap_76 - syn_state_76_shift) / ((real_ci_cap_76 + syn_state_76_shift) / 2)) %>%
summarize(avg_perc_chan_LR = mean(perc_chan, na.rm = TRUE))
# Save both SR_perc and LR_perc in the percent_change_revenue list
percent_change_revenue[[paste0(state_name, "_SR_perc")]] <- SR_perc
percent_change_revenue[[paste0(state_name, "_LR_perc")]] <- LR_perc
# Print the state_name, year_effective, short-run percentage change, and long-run percentage change
print(paste("State:", state_name))
print(paste("Year Effective:", year_effective))
print(paste("Short-Run Percentage Change in Revenue:", SR_perc$avg_perc_chan_SR))
print(paste("Long-Run Percentage Change in Revenue:", LR_perc$avg_perc_chan_LR))
}
View(percent_change_revenue)
# Part 6 Calculate the Percentage Change
# Initialize a list to store the percentage change dataframes for each state
percent_change_revenue <- list()
# Loop through each state's shifted dataframe in results_percentage
for (state_name in names(results_percentage)) {
# Get the shifted dataframe for the current state
shift_state <- results_percentage[[state_name]]
# Pull the year_effective[1] for the current state
year_effective <- shift_state$year_effective[1]
# Define the short-run years (year_effective[1], year_effective[1] + 1, year_effective[1] + 2)
short_run_years <- c(year_effective, year_effective + 1, year_effective + 2)
# Calculate the percentage change for the short run (and multiply by 100)
SR_perc <- shift_state %>%
filter(year %in% short_run_years) %>%
mutate(perc_chan = (real_ci_cap_76 - syn_state_76_shift) / ((real_ci_cap_76 + syn_state_76_shift) / 2) * 100) %>%
summarize(avg_perc_chan_SR = mean(perc_chan, na.rm = TRUE))
# Define the long-run period (you can adjust this as needed)
# Assuming the long-run years are all available years after the short run
LR_perc <- shift_state %>%
filter(year > (year_effective + 2)) %>%
mutate(perc_chan = (real_ci_cap_76 - syn_state_76_shift) / ((real_ci_cap_76 + syn_state_76_shift) / 2) * 100) %>%
summarize(avg_perc_chan_LR = mean(perc_chan, na.rm = TRUE))
# Save both SR_perc and LR_perc in the percent_change_revenue list
percent_change_revenue[[paste0(state_name, "_SR_perc")]] <- SR_perc
percent_change_revenue[[paste0(state_name, "_LR_perc")]] <- LR_perc
# Print the state_name, year_effective, short-run percentage change, and long-run percentage change
print(paste("State:", state_name))
print(paste("Year Effective:", year_effective))
print(paste("Short-Run Percentage Change in Revenue:", formatC(SR_perc$avg_perc_chan_SR, format = "f", digits = 4)))
print(paste("Long-Run Percentage Change in Revenue:", formatC(LR_perc$avg_perc_chan_LR, format = "f", digits = 4)))
}
write.csv(percent_change_revenue,"percent_change_CI_cap.csv",row.names = FALSE)
View(optimal_shifts_df)
# plot types, want two per state
# Plot 1: Raw synthetic vs Actual, plus base year 1976 normalized
ggplot() +
geom_vline(xintercept = year_effective_first, color = "black", linewidth = .75) +
geom_line(data = syn_Iowa, aes(x = year, y = real_ci_cap, color = "Actual (Raw)"), size = 1.2) +
geom_line(data = syn_Iowa, aes(x = year, y = syn_state, color = "Synthetic (Raw)"), linetype = "dotdash", size = 1.2) +
geom_line(data = Iowa_base76, aes(x = year, y = real_ci_cap_76, color = "Actual (1976 Normalized)"), size = 1.2, linetype = "dashed") +
labs(title = "Actual vs Synthetic CI per Capita (Raw and 1976 Normalized)",
x = "Year",
y = "Real CI per Capita") +
scale_color_manual(values = c("Actual (Raw)" = "red", "Synthetic (Raw)" = "blue", "Actual (1976 Normalized)" = "black"),
labels = c("Actual (Raw)", "Synthetic (Raw)", "Actual (1976 Normalized)")) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_stata()
# plot types, want two per state
# Plot 1: Raw synthetic vs Actual, plus base year 1976 normalized
ggplot() +
geom_vline(xintercept = year_effective_first, color = "black", linewidth = .75) +
geom_line(data = syn_Iowa, aes(x = year, y = real_ci_cap, color = "Actual (Raw)"), size = 1.2) +
geom_line(data = syn_Iowa, aes(x = year, y = syn_state, color = "Synthetic (Raw)"), linetype = "dotdash", size = 1.2) +
geom_line(data = Iowa_base76, aes(x = year, y = real_ci_cap_76, color = "Actual (1976 Normalized)"), size = 1.2, linetype = "dashed") +
labs(title = "Actual vs Synthetic CI per Capita (Raw and 1976 Normalized)",
x = "Year",
y = "Real CI per Capita") +
scale_color_manual(values = c("Actual (Raw)" = "red", "Synthetic (Raw)" = "blue", "Actual (1976 Normalized)" = "black"),
labels = c("Actual (Raw)", "Synthetic (Raw)", "Actual (1976 Normalized)")) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_stata()
# plot types, want two per state
# Plot 1: Raw synthetic vs Actual, plus base year 1976 normalized
ggplot() +
geom_vline(xintercept = year_effective_first, color = "black", linewidth = .75) +
geom_line(data = syn_Iowa, aes(x = year, y = real_ci_cap, color = "Actual (Raw)"), size = 1.2) +
geom_line(data = syn_Iowa, aes(x = year, y = syn_state, color = "Synthetic (Raw)"), linetype = "dotdash", size = 1.2) +
geom_line(data = Iowa_base76, aes(x = year, y = real_ci_cap_76, color = "Actual (1976 Normalized)"), size = 1.2, linetype = "dashed") +
labs(title = "Actual vs Synthetic CI per Capita (Raw and 1976 Normalized)",
x = "Year",
y = "Real CI per Capita") +
scale_color_manual(values = c("Actual (Raw)" = "red", "Synthetic (Raw)" = "blue", "Actual (1976 Normalized)" = "black"),
labels = c("Actual (Raw)", "Synthetic (Raw)", "Actual (1976 Normalized)")) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_stata()
ggplot(syn_Iowa, aes(x = year)) +
geom_vline(xintercept = year_effective_first, color = "black", linewidth = .75) +
geom_line(aes(y = real_ci_cap, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_Iowa, color = "Synthetic"), linetype = "dotdash", size = 1.2) +
labs(title = "Actual vs. Synthetic CI per Capita- Iowa",
x = "Year",
y = "Real CI per Capita ($)") +
scale_color_manual(values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = "Real Iowa", "Synthetic" = "Synthetic Iowa")) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_stata()
# ii Base Year 1976 synthetic v actual
ggplot(Iowa_base76, aes(x = year)) +
geom_vline(xintercept = year_effective_first, color = "black", linewidth = .75) +
geom_line(aes(y = real_ci_cap_76, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_Iowa_76, color = "Synthetic"), linetype = "dotdash", size = 1.2) +
labs(title = "Actual vs. Syn CI per Capita Iowa- Base Year 1976",
x = "Year",
y = "Real CI per Capita Normalized to 1976") +
scale_color_manual(values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = "Real Iowa", "Synthetic" = "Synthetic Iowa")) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_stata()
#iii) Shift
ggplot(shift_Iowa_base_76, aes(x = year)) +
geom_vline(xintercept = year_effective_first, color = "black", linewidth = .75) +
geom_line(aes(y = real_ci_cap_76, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_Iowa_76_shift, color = "Synthetic"), linetype = "dotdash", size = 1.2) +
labs(title = "Actual vs. Syn CI per Capita Iowa- Base 1976 & Shift",
x = "Year",
y = "Real CI per Capita Normalized to 1976") +
scale_color_manual(values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = "Real Iowa", "Synthetic" = "Synthetic Iowa")) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_stata()
View(results_percentage)
str(optimal_shifts_df)
for (state_name in names(results_percentage)) {
# Get the relevant dataframes for the state
syn_state <- results_percentage[[state_name]]  # Adjust this based on the correct data structure
#remove synthetic state
clean_state_name <- sub("_synthetic_state", "", state_name)
# Extract the optimal shift for the current state from optimal_shifts_df
optimal_shift_value <- optimal_shifts_df %>%
filter(State_Name == clean_state_name) %>%
pull(Optimal_Shift)
# Assuming you have data like "shift_state_base_76" and "year_effective_first" available in each state's data:
year_effective_first <- syn_state$year_effective[1]  # Use the correct column here
# Raw synthetic vs Actual plot
plot1 <- ggplot(syn_state, aes(x = year)) +
geom_vline(xintercept = year_effective_first, color = "black", linewidth = .75) +
geom_line(aes(y = real_ci_cap, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_state, color = "Synthetic"), linetype = "dotdash", size = 1.2) +
labs(title = paste("Actual vs. Synthetic CI per Capita -", state_name),
x = "Year",
y = "Real CI per Capita ($)") +
scale_color_manual(values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = paste("Real", state_name), "Synthetic" = paste("Synthetic", state_name))) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_stata()
# Save plot 1
ggsave(filename = paste0(state_name, "_synthetic_vs_actual_CI.png"), plot = plot1)
# Base Year 1976 synthetic vs Actual plot
plot2 <- ggplot(syn_state, aes(x = year)) +
geom_vline(xintercept = year_effective_first, color = "black", linewidth = .75) +
geom_line(aes(y = real_ci_cap_76, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_state_76, color = "Synthetic"), linetype = "dotdash", size = 1.2) +
labs(title = paste("Actual vs. Syn CI per Capita", state_name, "- Base Year 1976"),
x = "Year",
y = "Real CI per Capita Normalized to 1976") +
scale_color_manual(values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = paste("Real", state_name), "Synthetic" = paste("Synthetic", state_name))) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_stata()
# Save plot 2
ggsave(filename = paste0(state_name, "_base_1976_synthetic_vs_actual_CI.png"), plot = plot2)
# Shifted synthetic vs Actual plot and optimal shift in legend
plot3 <- ggplot(syn_state, aes(x = year)) +
geom_vline(xintercept = year_effective_first, color = "black", linewidth = .75) +
geom_line(aes(y = real_ci_cap_76, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_state_76_shift, color = "Synthetic"), linetype = "dotdash", size = 1.2) +
labs(title = paste("Actual vs. Syn CI per Capita", clean_state_name, "- Base 1976 & Shift"),
x = "Year",
y = "Real CI per Capita Normalized to 1976") +
scale_color_manual(values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = paste("Real", clean_state_name),
"Synthetic" = paste("Synthetic", clean_state_name, "\nOptimal Shift =", round(optimal_shift_value, 4)))) +  # Add shift value to legend
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_stata()
# Save plot 3
ggsave(filename = paste0(state_name, "_shift76_synthetic_vs_actual_CI.png"), plot = plot3)
}
# Shifted synthetic vs Actual plot and optimal shift in legend
plot3 <- ggplot(syn_state, aes(x = year)) +
geom_vline(xintercept = year_effective_first, color = "black", linewidth = .75) +
geom_line(aes(y = real_ci_cap_76, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_state_76_shift, color = "Synthetic"), linetype = "dotdash", size = 1.2) +
labs(title = paste("Actual vs. Syn CI per Capita", clean_state_name, "- Base 1976 & Shift"),
x = "Year",
y = "Real CI per Capita Normalized to 1976") +
scale_color_manual(values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = paste("Real", clean_state_name),
"Synthetic" = paste("Synthetic", clean_state_name, "\nOptimal Shift =", round(optimal_shift_value, 4)))) +  # Add shift value to legend
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_stata() +
theme(legend.text = element_text(size = 10),  # Increase legend text size
legend.position = "right")  # You can move the legend to the right or bottom for more space
print(plot3)
optimal_shift_value
optimal_shift
#remove synthetic state
clean_state_name <- sub("_synthetic_state", "", state_name)
# Debug: print the clean state name and see if it matches with the optimal_shifts_df$State_Name
print(paste("Current state name in loop:", clean_state_name))
#remove synthetic state
clean_state_name <- sub("_synthetic_shift", "", state_name)
# Debug: print the clean state name and see if it matches with the optimal_shifts_df$State_Name
print(paste("Current state name in loop:", clean_state_name))
print(optimal_shifts_df$State_Name)
# Extract the optimal shift for the current state from optimal_shifts_df
optimal_shift_value <- optimal_shifts_df %>%
filter(trimws(State_Name) == trimws(clean_state_name)) %>%  # trimws to remove any spaces
pull(Optimal_Shift)
for (state_name in names(results_percentage)) {
# Get the relevant dataframes for the state
syn_state <- results_percentage[[state_name]]  # Adjust this based on the correct data structure
#remove synthetic state
clean_state_name <- sub("_synthetic_shift", "", state_name)
# Debug: print the clean state name and see if it matches with the optimal_shifts_df$State_Name
print(paste("Current state name in loop:", clean_state_name))
print(optimal_shifts_df$State_Name)
# Extract the optimal shift for the current state from optimal_shifts_df
optimal_shift_value <- optimal_shifts_df %>%
filter(trimws(State_Name) == trimws(clean_state_name)) %>%  # trimws to remove any spaces
pull(Optimal_Shift)
# Assuming you have data like "shift_state_base_76" and "year_effective_first" available in each state's data:
year_effective_first <- syn_state$year_effective[1]  # Use the correct column here
# Raw synthetic vs Actual plot
plot1 <- ggplot(syn_state, aes(x = year)) +
geom_vline(xintercept = year_effective_first, color = "black", linewidth = .75) +
geom_line(aes(y = real_ci_cap, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_state, color = "Synthetic"), linetype = "dotdash", size = 1.2) +
labs(title = paste("Actual vs. Synthetic CI per Capita -", clean_state_name),
x = "Year",
y = "Real CI per Capita ($)") +
scale_color_manual(values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = paste("Real", clean_state_name), "Synthetic" = paste("Synthetic", clean_state_name))) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_stata()
# Save plot 1
ggsave(filename = paste0(clean_state_name, "_synthetic_vs_actual_CI.png"), plot = plot1)
# Base Year 1976 synthetic vs Actual plot
plot2 <- ggplot(syn_state, aes(x = year)) +
geom_vline(xintercept = year_effective_first, color = "black", linewidth = .75) +
geom_line(aes(y = real_ci_cap_76, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_state_76, color = "Synthetic"), linetype = "dotdash", size = 1.2) +
labs(title = paste("Actual vs. Syn CI per Capita", clean_state_name, "- Base Year 1976"),
x = "Year",
y = "Real CI per Capita Normalized to 1976") +
scale_color_manual(values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = paste("Real", clean_state_name), "Synthetic" = paste("Synthetic", clean_state_name))) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_stata()
# Save plot 2
ggsave(filename = paste0(clean_state_name, "_base_1976_synthetic_vs_actual_CI.png"), plot = plot2)
# Shifted synthetic vs Actual plot and optimal shift in legend
plot3 <- ggplot(syn_state, aes(x = year)) +
geom_vline(xintercept = year_effective_first, color = "black", linewidth = .75) +
geom_line(aes(y = real_ci_cap_76, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_state_76_shift, color = "Synthetic"), linetype = "dotdash", size = 1.2) +
labs(title = paste("Actual vs. Syn CI per Capita", clean_state_name, "- Base 1976 & Shift"),
x = "Year",
y = "Real CI per Capita Normalized to 1976") +
scale_color_manual(values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = paste("Real", clean_state_name),
"Synthetic" = paste("Synthetic", clean_state_name, "\nOptimal Shift =", round(optimal_shift_value, 4)))) +  # Add shift value to legend
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_stata()
# Save plot 3
ggsave(filename = paste0(state_name, "_shift76_synthetic_vs_actual_CI.png"), plot = plot3)
}
View(percent_change_revenue)
