#Attempt to Get Revenue in R
install.packages("readxl")
install.packages("tidyr")
install.packages("dplyr")
install.packages("did")
install.packages("tidyverse")
install.packages("lmtest")
library(readxl)
library(tidyr)
library(dplyr)
library(did)
library(tidyverse)
library(lmtest)
Census State and Local Data- Tax Foundation
# Census State and Local Data- Tax Foundation
install.packages("readxl")
install.packages("tidyr")
install.packages("dplyr")
install.packages("tidyverse")
install.packages("xlsx")
library(readxl)
library(tidyr)
library(dplyr)
library(tidyverse)
library(xlsx)
#Nebraska or "Direct Switchers DiD Approach"
#Run DiD with all the Direct Switchers (NE, MO, MS, CO, RI, ND, DE)
#Control Group is all States that Did not Switch by 2007.
#this includes: AK, HI, KS, NM, OK.  AL and MT between 2008-now became "Step
#-wise" switchers.  FL and MA had DWS over the whole period 1976-2022.
library(tidyr)
library(dplyr)
library(tidyverse)
# for robust standard error estimation
library(lmtest)
# To calculate correct vcov matrix with 2WFE
library(multiwayvcov)
# For a package way to do FE
library(plm)
#Fixest
install.packages("fixest")
library(fixest)
#Load Data Tables in R
install.packages("data.table")
# Get rate of change for tax bases and find elasticity of tax base w.r.t apportionment and rate changes.
#Redo Callaway and Sant'Anna From Summer
library(readxl)
library(tidyr)
library(dplyr)
library(did)
library(tidyverse)
library(lmtest)
library(caret)
library(ggplot2)
#New Directory
setwd("~/Documents/GitHub/ST_Apportionment/Rates_Of_Change")
#Load Packages
library(tidyr)
library(dplyr)
library(tidyverse)
library(lmtest)
library(ggplot2)
library(readxl) #load ssfa switch date
library(did) # for running DiD
library(caret)
library(plm) # for Two way FE
library(fixest) # multiple FE
#JMP Directory
setwd("~/Documents/GitHub/ST-Apportionment/job_market_data")
#Load files
Rev <- read.csv("filled_data_jmp.csv")
Log_rev <- read.csv("filled_log_data_jmp.csv")
Date <- read_xlsx("ssfa_data_jmp.xlsx")
#remove the X column, must be something that happens when saving CSV
Rev <-Rev %>%
select(-X)
Log_rev <- Log_rev %>%
select(-X)
#Now what approach?
#Going for Did
#reduce size of date dataframe:
Date2 <- Date %>%
select(state,year_effective,group)
#Merge those dates with Log_rev
Merge <- full_join(Log_rev,Date2, by="state")
#start with post and treatment columns
# Create a Post Column
merged_df2 <- Merge %>%
group_by(state) %>%
mutate(Post = ifelse(year_effective > year, 0, 1)) %>%
ungroup()
#Create a treatment column from the Post Column and the group column
merged_df3 <- merged_df2 %>%
mutate(treatment = ifelse(Post == 1 & group == "t", 1, 0))
#Create a Relative Year column for the Event Study Plot
# Create rel_year column
merged_df3$rel_year <- merged_df3$year - merged_df3$year_effective
#Need the result with Total Tax
Res <- merged_df3 %>%
mutate(log_totrev=log(TOTLTAX))
#Replace other NA's in post to be Zero
Res[c("Post")][is.na(Res[c("Post")])] <-0
#estimate a result for Total Taxes
treat_var <- "year_effective"
time_var <- "year"
#Make state a numeric factor
Res$state <- as.numeric(factor(Res$state))
#Run Callaway and Sant Anna, ran the Callaway and Sant Anna package, and dropped 419 rows
#it also gave a warning on small group sizes (all are small).  So, going to try,
#just Fixed effects regression
Res_attgt <- att_gt(yname = "log_totrev",
tname = "year",
idname = "state",
gname = "year_effective",
data = Res)
# Run Two way fixed Effect regression, OLS; dropped almost all abservations, will try again
log_tot_ols = feols(log_totrev ~ log(Post), Res)
summary(log_tot_ols)
#plm FE model
zz1 <- plm(log_totrev ~ factor(Post),Res)
#simple reg
Reg <- lm(log_totrev ~ Post + year + state,Res)
summary(Reg)
#Simple reg with rate
Reg_rate <- lm(log_totrev ~ Post + year + state + rates, Res)
summary(Reg_rate)
#simple reg, with log rate
reg_lrate <-lm(log_totrev ~ Post + year + state + log(rates), Res)
#Simple reg with rate, ran this and positive result for post went away
factor_rate <- lm(log_totrev ~ Post + factor(year) + factor(state) + rates, Res)
summary(factor_rate)
#try sales as numeric variable
sales_reg <- lm(log_totrev ~ sales + factor (year)+ factor(state) + rates, Res)
summary(sales_reg)
#For comparison, will try with log sales, #log rate will not run
log_sales_reg <- lm(log_totrev ~ log(sales) + factor (year)+ factor(state) + rates, Res)
summary(log_sales_reg)
# result for log(sales)        0.05897    0.01525   3.868 0.000113 ***
# result for log(sales)        0.05897    0.01525   3.868 0.000113 ***
# result for log(sales)        0.05897    0.01525   3.868 0.000113 ***
# result for log(sales)        0.05897    0.01525   3.868 0.000113 ***
# result for log(sales)        0.05897    0.01525   3.868 0.000113 ***
# result for log(sales)        0.05897    0.01525   3.868 0.000113 ***
# result for log(sales)        0.05897    0.01525   3.868 0.000113 ***
# result for log(sales)        0.05897    0.01525   3.868 0.000113 ***
# result for log(sales)        0.05897    0.01525   3.868 0.000113 ***
#simple reg
Reg <- lm(log_totrev ~ Post + year + state,Res)
summary(Reg)
#Simple Reg (w/o rate) (a) (i)
Simple_reg <- lm(log_totrev ~ Post + factor(year) + factor(state), Res)
summary(Simple_reg)
Interaction_reg <- lm(log_totrev ~ Post * factor(state) + factor(year), data = Res)
summary(Interaction_reg)
tidy_model <- tidy(Interaction_reg)
# Filter the coefficients to get only those related to Post
post_coefficients <- tidy_model %>%
filter(grepl("Post", term))
print(post_coefficients)
View(post_coefficients)
View(post_coefficients)
str(Res)
# Define the state acronyms and their corresponding state names
state_acronyms <- c("AK", "AL", "AR", "AZ", "CA", "CO", "CT", "DE", "FL", "GA",
"HI", "IA", "ID", "IL", "IN", "KS", "KY", "LA", "MA", "MD",
"ME", "MI", "MN", "MO", "MS", "MT", "NC", "ND", "NE", "NH",
"NJ", "NM", "NV", "NY", "OH", "OK", "OR", "PA", "RI", "SC",
"SD", "TN", "TX", "UT", "VA", "VT", "WA", "WI", "WV", "WY")
state_names <- c("Alaska", "Alabama", "Arkansas", "Arizona", "California", "Colorado",
"Connecticut", "Delaware", "Florida", "Georgia", "Hawaii", "Iowa",
"Idaho", "Illinois", "Indiana", "Kansas", "Kentucky", "Louisiana",
"Massachusetts", "Maryland", "Maine", "Michigan", "Minnesota",
"Missouri", "Mississippi", "Montana", "North Carolina", "North Dakota",
"Nebraska", "New Hampshire", "New Jersey", "New Mexico", "Nevada",
"New York", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island",
"South Carolina", "South Dakota", "Tennessee", "Texas", "Utah",
"Virginia", "Vermont", "Washington", "Wisconsin", "West Virginia",
"Wyoming")
# Create the dataframe
df <- data.frame(State_Acronym = state_acronyms, State_Name = state_names)
# Display the dataframe
print(df)
View(df)
Res3 <- Res %>%
full_join(df, by = c("State_Acronym"))
View(Res3)
Interaction_reg <- lm(log_totrev ~ Post * factor(State_Name) + factor(year), data = Res)
# Interaction Reg (with interaction between Post and state)
Interaction_reg <- lm(log_totrev ~ Post * factor(State_Name) + factor(year), data = Res3)
summary(Interaction_reg)
# Set Alabama as the reference category
Res3$State_Name <- relevel(factor(Res3$State_Name), ref = "Alabama")
# Interaction Reg (with interaction between Post and state)
Interaction_reg2 <- lm(log_totrev ~ Post * factor(State_Name) + factor(year), data = Res3)
summary(Interaction_reg2)
Res3$State_Name <- relevel(factor(Res3$State_Name), ref = "Alabama")
# Interaction Reg (with interaction between Post and state)
Interaction_reg2 <- lm(log_totrev ~ Post * factor(State_Name) + factor(year), data = Res3)
summary(Interaction_reg2)
tidy_model <- tidy(Interaction_reg2)
# Filter the coefficients to get only those related to Post
post_coefficients <- tidy_model %>%
filter(grepl("Post", term))
View(post_coefficients)
print(post_coefficients)
print(n=...)
fit_state_model <- function(df) {
lm(log_totrev ~ Post + factor(year), data = df)
}
state_models <- Res3 %>%
group_by(State_Name) %>%
group_map(~ fit_state_model(.x))
post_coeffs <- lapply(state_models, function(model) {
tidy(model) %>% filter(term == "Post")
})
# Set Alabama as the reference category
Res3$State_Name <- relevel(factor(Res3$State_Name), ref = "Alabama")
# Interaction regression with interaction between Post and state
interaction_model <- lm(log_totrev ~ Post * factor(State_Name) + factor(year), data = Res3)
summary(interaction_model)
# Extract coefficients for each state using Broom
tidy_interaction_model <- tidy(interaction_model)
# Filter the coefficients to get only those related to Post
post_interaction_coefficients <- tidy_interaction_model %>%
filter(grepl("Post", term))
print(post_interaction_coefficients)
# Create a data frame for the Post coefficients for each state
post_coefficients_combined <- post_interaction_coefficients %>%
mutate(State = ifelse(term == "Post", "Alabama", gsub("Post:factor\\(State_Name\\)", "", term)),
Post_Estimate = ifelse(term == "Post", estimate, estimate + post_interaction_coefficients$estimate[post_interaction_coefficients$term == "Post"])) %>%
select(State, Post_Estimate)
print(post_coefficients_combined)
View(post_coefficients_combined)
View(post_coefficients_combined)
View(post_interaction_coefficients)
post_coefficients_combined <- post_interaction_coefficients %>%
mutate(
State = ifelse(term == "Post", "Alabama", gsub("Post:factor\\(State_Name\\)", "", term)),
Post_Estimate = ifelse(term == "Post", estimate, estimate + post_interaction_coefficients$estimate[post_interaction_coefficients$term == "Post"]),
Post_Std_Error = ifelse(term == "Post", std.error, std.error + post_interaction_coefficients$std.error[post_interaction_coefficients$term == "Post"]),
Post_Statistic = ifelse(term == "Post", statistic, statistic + post_interaction_coefficients$statistic[post_interaction_coefficients$term == "Post"]),
Post_P_Value = ifelse(term == "Post", p.value, p.value + post_interaction_coefficients$p.value[post_interaction_coefficients$term == "Post"])
) %>%
select(State, Post_Estimate, Post_Std_Error, Post_Statistic, Post_P_Value)
print(post_coefficients_combined)
print(post_coefficients_combined, n= Inf)
post_coefficients_combined <- post_interaction_coefficients %>%
mutate(
State = ifelse(term == "Post", "Alabama", gsub("Post:factor\\(State_Name\\)", "", term)),
Post_Estimate = ifelse(term == "Post", estimate, estimate + post_interaction_coefficients$estimate[post_interaction_coefficients$term == "Post"]),
Post_Std_Error = std.error,
Post_Statistic = statistic,
Post_P_Value = p.value
) %>%
select(State, Post_Estimate, Post_Std_Error, Post_Statistic, Post_P_Value)
print(post_coefficients_combined, n= Inf)
View(post_coefficients_combined)
options(digits=9)
print(post_coefficients_combined, n= Inf)
View(post_coefficients_combined)
print(post_coefficients_combined, n= Inf)
print(
post_coefficients_combined %>%
mutate(across(where(is.numeric), ~ format(.x, digits = 8, scientific = FALSE))),
n = Inf
)
print(
post_coefficients_combined %>%
mutate(across(where(is.numeric), ~ format(.x, digits = 6, scientific = FALSE))),
n = Inf
)
write.csv(post_coefficients_combined,"state_post_dummy_total_rev.csv")
#save the Res3 dataframe, which was the foundation for the result.
write.csv(Res3,"revenue_panel_total_rev_state_coef_result.csv")
#Simple_reg <- lm(log_totrev ~ Post + factor(year) + factor(state), Res)
write.csv(post_coefficients_combined,"state_post_dummy_total_rev._6_15_24.csv")
#save the Res3 dataframe, which was the foundation for the result.
write.csv(Res3,"revenue_panel_total_rev_state_coef_result_6_15_24.csv")
