library(tidyr)
library(dplyr)
library(did)
library(tidyverse)
library(lmtest)
Census State and Local Data- Tax Foundation
# Census State and Local Data- Tax Foundation
install.packages("readxl")
install.packages("tidyr")
install.packages("dplyr")
install.packages("tidyverse")
install.packages("xlsx")
library(readxl)
library(tidyr)
library(dplyr)
library(tidyverse)
library(xlsx)
#Nebraska or "Direct Switchers DiD Approach"
#Run DiD with all the Direct Switchers (NE, MO, MS, CO, RI, ND, DE)
#Control Group is all States that Did not Switch by 2007.
#this includes: AK, HI, KS, NM, OK.  AL and MT between 2008-now became "Step
#-wise" switchers.  FL and MA had DWS over the whole period 1976-2022.
library(tidyr)
library(dplyr)
library(tidyverse)
# for robust standard error estimation
library(lmtest)
# To calculate correct vcov matrix with 2WFE
library(multiwayvcov)
# For a package way to do FE
library(plm)
#Fixest
install.packages("fixest")
library(fixest)
#Load Data Tables in R
install.packages("data.table")
# Get rate of change for tax bases and find elasticity of tax base w.r.t apportionment and rate changes.
#Redo Callaway and Sant'Anna From Summer
library(readxl)
library(tidyr)
library(dplyr)
library(did)
library(tidyverse)
library(lmtest)
library(caret)
library(ggplot2)
#New Directory
setwd("~/Documents/GitHub/ST_Apportionment/Rates_Of_Change")
Run a one-sided Significance test
#Load Packages
library(tidyr)
library(dplyr)
library(tidyverse)
library(lmtest)
library(ggplot2)
library(did) # for running DiD
library(plm)
library(lmtest)
library(synthdid)
library(fixest)
library(boot)
library(ggthemes)
# set seed
set.seed(26)
#JMP Directory
setwd("~/Documents/GitHub/ST-Apportionment/job_market_data")
naive_ci<-read.csv("naive_ci.csv")
real_CI <- naive_ci%>%
mutate(real_ci = (naive_ci/CPI_def)*100)
real_CI_cap <- real_CI %>%
mutate(real_ci_cap = real_ci/population)
Filter_frac <-real_CI %>%
select(State_Acronym,year,year_effective,State_Name,real_ci,Post)
not_yet_treated <- Filter_frac %>%
group_by(State_Name)%>%
filter(Post == 1 & year_effective > 2021)
never_treated <- Filter_frac %>%
group_by(State_Name)%>%
filter(Post == 0 & year_effective >2021 | is.na( year_effective)) %>%
filter(!(State_Acronym == "OH"))
control <- rbind(never_treated,not_yet_treated) %>%
distinct(State_Name)
Filter_frac <-real_CI_cap %>%
select(State_Acronym,year,year_effective,State_Name,real_ci_cap,Post)
not_yet_treated <- Filter_frac %>%
group_by(State_Name)%>%
filter(Post == 1 & year_effective > 2021)
never_treated <- Filter_frac %>%
group_by(State_Name)%>%
filter(Post == 0 & year_effective >2021 | is.na( year_effective)) %>%
filter(!(State_Acronym == "OH"))
control <- rbind(never_treated,not_yet_treated) %>%
distinct(State_Name)
#Create Illinois Panel from Illinois and control
Illinois <- Filter_frac %>%
filter(State_Name == "Illinois" | State_Name %in% control$State_Name)
View(Illinois)
#try synthetic DiD again, with the mirrored changes, see if the weights change
base_year76 <- Illinois %>%
group_by(State_Acronym) %>%
mutate(
real_ci_cap_relative = (real_ci_cap / real_ci_cap[year == 1976]) * 100
) %>%
ungroup()
# Filter out rows with year <= 2 years after treatment_year
base_df <- base_year76 %>%
filter(year <= 1999 + 2)
## sDiD estimate
# Create the panel matrices for sDiD using synthdid
current_sDiD <- panel.matrices(base_df, unit = "State_Acronym", time = "year", outcome = "real_ci_cap_relative", treatment = "Post")
base_df <- base_year76 %>%
filter(year <= 1999 + 2 & year> 1976)
## sDiD estimate
# Create the panel matrices for sDiD using synthdid
current_sDiD <- panel.matrices(base_df, unit = "State_Acronym", time = "year", outcome = "real_ci_cap_relative", treatment = "Post")
#Create Illinois without  Alaska or Hawaii... too volatile for revenue
Illinois_noAK_HA <- Filter_frac %>%
filter(State_Name == "Illinois" | State_Name %in% control_noAK_HA$State_Name)
control_noAK_HA <-rbind(never_treated,not_yet_treated)%>%
filter(!(State_Name == "Alaska" | State_Name == "Hawaii")) %>%
distinct(State_Name)
#Create Illinois without  Alaska or Hawaii... too volatile for revenue
Illinois_noAK_HA <- Filter_frac %>%
filter(State_Name == "Illinois" | State_Name %in% control_noAK_HA$State_Name)
# Filter out rows with year <= 2 years after treatment_year
df <- Illinois_noAK_HA %>%
filter(year <= 1999 + 2)
## sDiD estimate
# Create the panel matrices for sDiD using synthdid
current_sDiD <- panel.matrices(df, unit = "State_Acronym", time = "year", outcome = "real_ci_cap", treatment = "Post")
# Calculate the synthetic difference-in-differences estimate
current_tau_hat <- synthdid_estimate(current_sDiD$Y, current_sDiD$N0, current_sDiD$T0)
summary(current_tau_hat)
#Controls for spaghetti plot
top.controls = synthdid_controls(current_tau_hat)[1:6, , drop=FALSE]
plot(current_tau_hat, spaghetti.units=rownames(top.controls)) +
labs(x = "Year", y = "Real, Naive Corporate Income per Capita") +
ggtitle(paste("Spaghetti Plot sDiD Illinois Top Controls")) +
theme_fivethirtyeight() +
theme(
axis.title.x = element_text(size = 12),
axis.title.y = element_text(size = 12),
axis.text.x = element_text(size = 10),
axis.text.y = element_text(size = 10),
plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
axis.line = element_line(linewidth = 0.5, colour = "black")
)
#Creat plot for No AK or Hawaii list
# Weights from the sDiD summary output
NH_weight <- 0.237
ID_weight <- 0.199
FL_weight <- 0.149
MA_weight <- 0.145
MT_weight <- 0.126
NM_weight <- 0.114
#create synthetic Illinois
syn_Illinois_noAH <- (NH_weight * NH_values$real_ci_cap) +
(ID_weight * ID_values$real_ci_cap) +
(FL_weight * FL_values$real_ci_cap) +
(MA_weight * MA_values$real_ci_cap) +
(MT_weight * MT_values$real_ci_cap) +
(NM_weight * NM_values$real_ci_cap)
#Pull values for synthetic Illinois
NH_values <- Filter_frac %>%
filter(State_Acronym == "NH") %>%
select(State_Acronym, year, real_ci_cap)
MA_values <- Filter_frac %>%
filter(State_Acronym == "MA") %>%
select(State_Acronym, year, real_ci_cap)
WV_values <- Filter_frac %>%
filter(State_Acronym == "WV") %>%
select(State_Acronym, year, real_ci_cap)
TN_values <- Filter_frac %>%
filter(State_Acronym == "TN") %>%
select(State_Acronym, year, real_ci_cap)
ID_values <- Filter_frac %>%
filter(State_Acronym == "ID") %>%
select(State_Acronym, year, real_ci_cap)
FL_values <- Filter_frac %>%
filter(State_Acronym == "FL") %>%
select(State_Acronym, year, real_ci_cap)
KS_values <- Filter_frac %>%
filter(State_Acronym == "KS") %>%
select(State_Acronym, year, real_ci_cap)
NM_values <- Filter_frac %>%
filter(State_Acronym == "NM") %>%
select(State_Acronym, year, real_ci_cap)
MS_values <- Filter_frac %>%
filter(State_Acronym == "MS") %>%
select(State_Acronym, year, real_ci_cap)
VA_values <- Filter_frac %>%
filter(State_Acronym == "VA") %>%
select(State_Acronym, year, real_ci_cap)
MT_values <- Filter_frac %>%
filter(State_Acronym == "MT") %>%
select(State_Acronym, year, real_ci_cap)
VT_values <- Filter_frac %>%
filter(State_Acronym == "VT") %>%
select(State_Acronym, year, real_ci_cap)
HI_values <- Filter_frac %>%
filter(State_Acronym == "HI") %>%
select(State_Acronym, year, real_ci_cap)
#create synthetic Illinois
syn_Illinois_noAH <- (NH_weight * NH_values$real_ci_cap) +
(ID_weight * ID_values$real_ci_cap) +
(FL_weight * FL_values$real_ci_cap) +
(MA_weight * MA_values$real_ci_cap) +
(MT_weight * MT_values$real_ci_cap) +
(NM_weight * NM_values$real_ci_cap)
#Plot No AK or HA control
Illinois_noAH_plot <- Filter_frac %>%
filter(State_Acronym == "IL") %>%
select(State_Acronym, year, real_ci_cap) %>%
mutate(syn_Illinois = syn_Illinois_noAH)
#Plot of synthetic and actual Illinois
ggplot(Illinois_plot, aes(x = year)) +
geom_line(aes(y = real_ci_cap, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_Illinois_noAH, color = "Synthetic"), size = 1.2) +
labs(title = "Actual vs. Synthetic Naive CI per Capita for Illinois- No AK or HA",
x = "Year",
y = "Real CI") +
scale_color_manual(values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = "Real IL", "Synthetic" = "Synthetic IL")) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_fivethirtyeight()
View(Illinois_noAK_HA)
#Plot of synthetic and actual Illinois
ggplot(Illinois_noAH_plot, aes(x = year)) +
geom_line(aes(y = real_ci_cap, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_Illinois_noAH, color = "Synthetic"), size = 1.2) +
labs(title = "Actual vs. Synthetic Naive CI per Capita for Illinois- No AK or HA",
x = "Year",
y = "Real CI") +
scale_color_manual(values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = "Real IL", "Synthetic" = "Synthetic IL")) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_fivethirtyeight()
Filter_frac <-real_CI_cap %>%
select(State_Acronym,year,year_effective,State_Name,real_ci_cap,Post)
not_yet_treated <- Filter_frac %>%
group_by(State_Name)%>%
filter(Post == 1 & year_effective > 2021)
never_treated <- Filter_frac %>%
group_by(State_Name)%>%
filter(Post == 0 & year_effective >2021 | is.na( year_effective)) %>%
filter(!(State_Acronym == "OH"))
control <- rbind(never_treated,not_yet_treated) %>%
distinct(State_Name)
control_noAK_HA <-rbind(never_treated,not_yet_treated)%>%
filter(!(State_Name == "Alaska" | State_Name == "Hawaii")) %>%
distinct(State_Name)
## sDiD estimate
# Create the panel matrices for sDiD using synthdid
current_sDiD <- panel.matrices(df, unit = "State_Acronym", time = "year", outcome = "real_ci_cap", treatment = "Post")
# Calculate the synthetic difference-in-differences estimate
current_tau_hat <- synthdid_estimate(current_sDiD$Y, current_sDiD$N0, current_sDiD$T0)
summary(current_tau_hat)
# Weights from the sDiD summary output
NH_weight <- 0.237
ID_weight <- 0.199
FL_weight <- 0.149
MA_weight <- 0.145
MT_weight <- 0.126
NM_weight <- 0.114
#create synthetic Illinois
syn_Illinois_noAH <- (NH_weight * NH_values$real_ci_cap) +
(ID_weight * ID_values$real_ci_cap) +
(FL_weight * FL_values$real_ci_cap) +
(MA_weight * MA_values$real_ci_cap) +
(MT_weight * MT_values$real_ci_cap) +
(NM_weight * NM_values$real_ci_cap)
#Plot No AK or HA control
Illinois_noAH_plot <- Filter_frac %>%
filter(State_Acronym == "IL") %>%
select(State_Acronym, year, real_ci_cap) %>%
mutate(syn_Illinois = syn_Illinois_noAH)
#Plot of synthetic and actual Illinois
ggplot(Illinois_noAH_plot, aes(x = year)) +
geom_line(aes(y = real_ci_cap, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_Illinois_noAH, color = "Synthetic"), size = 1.2) +
labs(title = "Actual vs. Synthetic Naive CI per Capita for Illinois- No AK or HA",
x = "Year",
y = "Real CI") +
scale_color_manual(values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = "Real IL", "Synthetic" = "Synthetic IL")) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_fivethirtyeight()
#Now create a shift up
ill_diff <- Illinois_plot %>%
filter(year == 1999) %>%
summarize(shift = real_ci_cap - syn_Illinois)%>%
mutate(syn_plus_shift = shift + syn_Illinois)
Illinois_shift <- Illinois_plot %>%
mutate(syn_plus_shift = ill_diff$shift + syn_Illinois)
View(Filter_frac)
Illinois_plot <- Filter_frac %>%
filter(State_Acronym == "IL") %>%
select(State_Acronym, year, real_ci_cap) %>%
mutate(syn_Illinois = syn_Illinois_noAH)
#Plot of synthetic and actual Illinois
ggplot(Illinois_plot, aes(x = year)) +
geom_line(aes(y = real_ci_cap, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_Illinois, color = "Synthetic"), size = 1.2) +
labs(title = "Actual vs. Synthetic Naive CI per Capita for Illinois",
x = "Year",
y = "Real CI") +
scale_color_manual(values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = "Real IL", "Synthetic" = "Synthetic IL")) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_fivethirtyeight()
#Create base dataframe that has nat_share as dependent variable.
Filter_frac <-real_CI_cap %>%
select(State_Acronym,year,year_effective,State_Name,real_ci_cap,Post)
base76 <- Illinois_plot %>%
group_by(State_Acronym) %>%
mutate(
real_ci_cap_relative = (real_ci_cap / real_ci_cap[year == 1976]) * 100,
syn_Illinois_relative = (syn_Illinois / syn_Illinois[year == 1976]) * 100
) %>%
ungroup()
View(base76)
View(base76)
#plot with base trend
ggplot(base76, aes(x = year)) +
geom_line(aes(y = real_ci_cap_relative, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_Illinois_relative, color = "Synthetic Shift"), size = 1.2) +
labs(title = "Actual vs. Synthetic Naive CI per Capita for Illinois- Shift",
x = "Year",
y = "Real CI") +
scale_color_manual(values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = "Real IL", "Synthetic" = "Synthetic IL")) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_fivethirtyeight()
#plot with base trend
ggplot(base76, aes(x = year)) +
geom_line(aes(y = real_ci_cap_relative, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_Illinois_relative, color = "Synthetic Shift"), size = 1.2) +
labs(title = "Actual vs. Synthetic Naive CI per Capita for Illinois- Base Year 1976",
x = "Year",
y = "Real CI") +
scale_color_manual(values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = "Real IL", "Synthetic" = "Synthetic IL")) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_fivethirtyeight()
ggplot(base76, aes(x = year)) +
geom_line(aes(y = real_ci_cap_relative, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_Illinois_relative, color = "Synthetic"), size = 1.2) +
labs(title = "Actual vs. Synthetic Naive CI per Capita for Illinois- Base Year 1976",
x = "Year",
y = "Real CI") +
scale_color_manual(values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = "Real IL", "Synthetic" = "Synthetic IL")) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_fivethirtyeight()
ggplot(base76, aes(x = year)) +
geom_line(aes(y = real_ci_cap_relative, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_Illinois_relative, color = "Synthetic"), size = 1.2) +
labs(title = "Actual vs. Synthetic Naive CI per Capita for Illinois- Base Year 1976",
x = "Year",
y = "Real CI per Capita") +
scale_color_manual(values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = "Real IL", "Synthetic" = "Synthetic IL")) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_fivethirtyeight()
ggplot(base76, aes(x = year)) +
geom_line(aes(y = real_ci_cap_relative, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_Illinois_relative, color = "Synthetic"), size = 1.2) +
labs(
title = "Actual vs. Synthetic Naive CI per Capita for Illinois - Base Year 1976",
x = "Year",
y = "Real CI per Capita"
) +
scale_color_manual(
values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = "Real IL", "Synthetic" = "Synthetic IL")
) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_fivethirtyeight() +
geom_vline(xintercept = 1999, linetype = "dashed", color = "black", size = 1) +
theme(
legend.position = "right",  # Adjust legend position if needed
legend.title = element_text(size = 12),  # Customize legend title size
legend.text = element_text(size = 10)    # Customize legend text size
)
ill_norm_shift <- base76 %>%
filter(year == 1999) %>%
summarize(shift = real_ci_cap - syn_Illinois)%>%
mutate(syn_plus_shift = shift + syn_Illinois)
str(base76)
#Now create a shift up
ill_norm_shift <- base76 %>%
filter(year == 1999) %>%
summarize(shift = real_ci_cap_relative - syn_Illinois_relative)%>%
mutate(syn_plus_shift = shift + syn_Illinois_relative)
View(base_year76)
ill_norm_shift <- base76 %>%
filter(year == 1999) %>%
summarize(shift = real_ci_cap_relative - syn_Illinois_relative)
View(ill_norm_shift)
Illinois_shift <- base76 %>%
mutate(syn_plus_shift = ill_diff$shift + syn_Illinois_relative)
Illinois_shift <- base76 %>%
mutate(syn_plus_shift = ill_norm_shift$shift + syn_Illinois_relative)
View(Illinois_shift)
#Plot with shift and normalization to 1976
ggplot(Illinois_shift, aes(x = year)) +
geom_line(aes(y = real_ci_cap_relative, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_plus_shift, color = "Synthetic"), size = 1.2) +
labs(title = "Actual vs. Synthetic Naive CI/Capita for Il- Shift/Base 76",
x = "Year",
y = "Real CI") +
scale_color_manual(values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = "Real IL", "Synthetic" = "Synthetic IL")) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_fivethirtyeight()
#Plot with shift and normalization to 1976
ggplot(Illinois_shift, aes(x = year)) +
geom_line(aes(y = real_ci_cap_relative, color = "Actual"), size = 1.2) +
geom_line(aes(y = syn_plus_shift, color = "Synthetic"), size = 1.2) +
labs(title = "Actual vs. Synthetic Naive CI/Capita for Illinois- Shift/Base 76",
x = "Year",
y = "Real CI") +
scale_color_manual(values = c("Actual" = "red", "Synthetic" = "blue"),
labels = c("Actual" = "Real IL", "Synthetic" = "Synthetic IL")) +
guides(color = guide_legend(title = "Corporate Income Type")) +
theme_fivethirtyeight()
View(base_year76)
#Want to save dataframe with normalized data to 1976
write.csv(base76,"normalized_syn_illinois.csv", row.names = FALSE)
View(Illinois)
# Create the panel matrices for sDiD using synthdid
current_sDiD <- panel.matrices(Illinois, unit = "State_Acronym", time = "year", outcome = "real_ci", treatment = "Post")
# Create the panel matrices for sDiD using synthdid
current_sDiD <- panel.matrices(Illinois, unit = "State_Acronym", time = "year", outcome = "real_ci_cap", treatment = "Post")
Illinois <- Filter_frac %>%
filter(State_Name == "Illinois" | State_Name %in% never_treated$State_Name)
View(Illinois)
df <- Illinois %>%
filter(year >= 2022)
df <- Illinois %>%
filter(year <= 2022)
df <- Illinois %>%
filter(year < 2022)
# Create the panel matrices for sDiD using synthdid
current_sDiD <- panel.matrices(df, unit = "State_Acronym", time = "year", outcome = "real_ci_cap", treatment = "Post")
# Calculate the synthetic difference-in-differences estimate
current_tau_hat <- synthdid_estimate(current_sDiD$Y, current_sDiD$N0, current_sDiD$T0)
se <- sqrt(vcov(current_tau_hat, method = 'placebo'))
# Calculate the t-statistic
t_statistic <- (as.numeric(current_tau_hat)-0) / se
# Calculate the p-value
p_value_two_tail <- 2 * pt(-abs(t_statistic), df = nrow(df) - 1)
# Plot and save the sDiD estimate
plot <- plot(current_tau_hat) +
labs(x = "Year", y = "Real, Naive Corporate Income") +
ggtitle(paste("sDiD Illinois and Never + Not Yet Treated Control")) +
theme_fivethirtyeight() +
theme(
axis.title.x = element_text(size = 12),
axis.title.y = element_text(size = 12),
axis.text.x = element_text(size = 10),
axis.text.y = element_text(size = 10),
plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
axis.line = element_line(linewidth = 0.5, colour = "black")
)
# Plot and save the sDiD estimate
plot <- plot(current_tau_hat) +
labs(x = "Year", y = "Real, Naive Corporate Income") +
ggtitle(paste("sDiD Illinois and Never + Not Yet Treated Control")) +
theme_fivethirtyeight() +
theme(
axis.title.x = element_text(size = 12),
axis.title.y = element_text(size = 12),
axis.text.x = element_text(size = 10),
axis.text.y = element_text(size = 10),
plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
axis.line = element_line(linewidth = 0.5, colour = "black")
)
summary(current_tau_hat)
se <- sqrt(vcov(current_tau_hat, method = 'placebo'))
# Calculate the t-statistic
t_statistic <- (as.numeric(current_tau_hat)-0) / se
# Calculate the p-value
p_value_two_tail <- 2 * pt(-abs(t_statistic), df = nrow(df) - 1)
# Plot sDiD estimate
plot <- plot(current_tau_hat) +
labs(x = "Year", y = "Real, Naive Corporate Income") +
ggtitle(paste("sDiD Illinois and Never Treated Control")) +
theme_fivethirtyeight() +
theme(
axis.title.x = element_text(size = 12),
axis.title.y = element_text(size = 12),
axis.text.x = element_text(size = 10),
axis.text.y = element_text(size = 10),
plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
axis.line = element_line(linewidth = 0.5, colour = "black")
)
print(plot)
plot <- plot(current_tau_hat) +
labs(x = "Year", y = "Real, Naive Corporate Income") +
ggtitle(paste("sDiD Illinois and Never Treated Control- Long Run")) +
theme_fivethirtyeight() +
theme(
axis.title.x = element_text(size = 12),
axis.title.y = element_text(size = 12),
axis.text.x = element_text(size = 10),
axis.text.y = element_text(size = 10),
plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
axis.line = element_line(linewidth = 0.5, colour = "black")
)
# Print the plot
print(plot)
