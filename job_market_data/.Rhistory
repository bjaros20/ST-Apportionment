# Set working directory (modify as needed)
setwd("~/Documents/GitHub/ST-Apportionment/job_market_data")
# Load data
data <- read.csv("real_log_nci.csv")
View(data)
# --- Filter for 2006 and late switchers, through 2014 only
data_2006 <- data %>%
filter(year_effective %in% c(2006, 2015, 2016, 2017, 2018),
year <= 2014) %>%
mutate(
Treated = ifelse(year_effective == 2006, 1, 0),
Post = ifelse(year >= year_effective, 1, 0),
DiD = Treated * Post
)
# --- TWFE model
model_twfe_2006 <- feols(logRealCitRev ~ Post | State_Acronym + year, data = data_2006)
# --- Simple DiD model
model_did_2006 <- feols(logRealCitRev ~ Treated + Post + DiD, data = data_2006)
#2007 Switchers, SC, PA, MN, ME, IN, AZ
data_2007 <- data %>%
filter(year_effective %in% c(2007, 2015, 2016, 2017, 2018),
year <= 2014) %>%
mutate(
Treated = ifelse(year_effective == 2007, 1, 0),
Post = ifelse(year >= year_effective, 1, 0),
DiD = Treated * Post
)
# --- TWFE model
model_twfe_2007 <- feols(logRealCitRev ~ Post | State_Acronym + year, data = data_2007)
# --- Simple DiD model
model_did_2007 <- feols(logRealCitRev ~ Treated + Post + DiD, data = data_2007)
#2006 and 2007 Switchers
data_0607 <- data %>%
filter(year_effective %in% c(2006, 2007, 2015, 2016, 2017, 2018),
year <= 2014) %>%
mutate(
Treated = ifelse(year_effective %in% c(2006, 2007), 1, 0),
Post = ifelse(year >= year_effective, 1, 0),
DiD = Treated * Post
)
# --- TWFE model
model_twfe_0607 <- feols(logRealCitRev ~ Post | State_Acronym + year, data = data_0607)
# --- Simple DiD model
model_did_0607 <- feols(logRealCitRev ~ Treated + Post + DiD, data = data_0607)
#Event Specifications
event_study_2006 <- feols(
logRealCitRev ~ i(year, Treated, ref = 2005) | State_Acronym + year,
data = data_2006,
cluster = ~State_Acronym
)
event_study_2007 <- feols(
logRealCitRev ~ i(year, Treated, ref = 2006) | State_Acronym + year,
data = data_2007,
cluster = ~State_Acronym
)
event_study_0607 <- feols(
logRealCitRev ~ i(year, Treated, ref = 2006) | State_Acronym + year,
data = data_0607,
cluster = ~State_Acronym
)
# TWFE
summary(twfe_corporate_0607, cluster = ~State_Acronym)
# TWFE
summary(model_twfe_0607, cluster = "State_Acronym")
# Simple DiD
summary(model_did_0607)
# Event Study
summary(event_study_0607, cluster = "State_Acronym")
# TWFE
summary(model_twfe_2006, cluster = "State_Acronym")
# Simple DiD
summary(model_did_2006)
# Event Study
summary(event_study_2006, cluster = "State_Acronym")
# TWFE
summary(model_twfe_2007, cluster = "State_Acronym")
# Simple DiD
summary(model_did_2007)
# Event Study
summary(event_study_2007, cluster = "State_Acronym")
# --- Filter for 2006 and late switchers (GA, WI), from 1990 to 2014
data_2006 <- data %>%
filter(year_effective %in% c(2006, 2015, 2016, 2017, 2018),
year >= 1990, year <= 2014) %>%
mutate(
Treated = ifelse(year_effective == 2006, 1, 0),
Post = ifelse(year >= year_effective, 1, 0),
DiD = Treated * Post
)
# --- TWFE and Simple DiD
model_twfe_2006 <- feols(logRealCitRev ~ Post | State_Acronym + year, data = data_2006)
model_did_2006  <- feols(logRealCitRev ~ Treated + Post + DiD, data = data_2006)
# --- Filter for 2007 and late switchers (SC, PA, MN, ME, IN, AZ), from 1990 to 2014
data_2007 <- data %>%
filter(year_effective %in% c(2007, 2015, 2016, 2017, 2018),
year >= 1990, year <= 2014) %>%
mutate(
Treated = ifelse(year_effective == 2007, 1, 0),
Post = ifelse(year >= year_effective, 1, 0),
DiD = Treated * Post
)
# --- TWFE and Simple DiD
model_twfe_2007 <- feols(logRealCitRev ~ Post | State_Acronym + year, data = data_2007)
model_did_2007  <- feols(logRealCitRev ~ Treated + Post + DiD, data = data_2007)
# --- Filter for 2006 + 2007 and late switchers, from 1990 to 2014
data_0607 <- data %>%
filter(year_effective %in% c(2006, 2007, 2015, 2016, 2017, 2018),
year >= 1990, year <= 2014) %>%
mutate(
Treated = ifelse(year_effective %in% c(2006, 2007), 1, 0),
Post = ifelse(year >= year_effective, 1, 0),
DiD = Treated * Post
)
# --- TWFE and Simple DiD
model_twfe_0607 <- feols(logRealCitRev ~ Post | State_Acronym + year, data = data_0607)
model_did_0607  <- feols(logRealCitRev ~ Treated + Post + DiD, data = data_0607)
# --- Event-Study Models (ref = year prior to treatment)
event_study_2006 <- feols(
logRealCitRev ~ i(year, Treated, ref = 2005) | State_Acronym + year,
data = data_2006,
cluster = ~State_Acronym
)
event_study_2007 <- feols(
logRealCitRev ~ i(year, Treated, ref = 2006) | State_Acronym + year,
data = data_2007,
cluster = ~State_Acronym
)
event_study_0607 <- feols(
logRealCitRev ~ i(year, Treated, ref = 2006) | State_Acronym + year,
data = data_0607,
cluster = ~State_Acronym
)
# TWFE
summary(model_twfe_0607, cluster = "State_Acronym")
# Simple DiD
summary(model_did_0607)
# Event Study
summary(event_study_0607, cluster = "State_Acronym")
# TWFE
summary(model_twfe_2006, cluster = "State_Acronym")
# Simple DiD
summary(model_did_2006)
# Event Study
summary(event_study_2006, cluster = "State_Acronym")
# TWFE
summary(model_twfe_2007, cluster = "State_Acronym")
# Simple DiD
summary(model_did_2007)
# Event Study
summary(event_study_2007, cluster = "State_Acronym")
# Define model specifications
event_study_specs <- list(
`2006` = list(
data = data_2006,
ref = 2005
),
`2007` = list(
data = data_2007,
ref = 2006
),
`0607` = list(
data = data_0607,
ref = 2006
)
)
# Define outcomes and labels
outcomes <- list(
logRealCitRev = "Corporate Tax Revenue",
log_RNCTR = "Non-Corporate Tax Revenue",
real_log_nci = "Proxy Corporate Income"
)
# Loop through each group and each outcome
for (group in names(event_study_specs)) {
data_used <- event_study_specs[[group]]$data
ref_year <- event_study_specs[[group]]$ref
cat("\n=============================\n")
cat(paste("Group:", group, "- Reference Year:", ref_year, "\n"))
cat("=============================\n")
for (outcome_var in names(outcomes)) {
model_name <- paste0("event_study_", group, "_", outcome_var)
cat(paste0("\n>> Estimating: ", outcomes[[outcome_var]], "\n"))
model <- feols(
as.formula(paste0(outcome_var, " ~ i(year, Treated, ref = ", ref_year, ") | State_Acronym + year")),
data = data_used,
cluster = ~State_Acronym
)
print(summary(model))
}
}
# Define model specifications
event_study_specs <- list(
`2006` = list(
data = data_2006,
ref = 2005
),
`2007` = list(
data = data_2007,
ref = 2006
),
`0607` = list(
data = data_0607,
ref = 2006
)
)
# Define outcomes and labels
outcomes <- list(
logRealCitRev = "Corporate Tax Revenue",
log_RNCTR = "Non-Corporate Tax Revenue",
real_log_nci = "Proxy Corporate Income"
)
# Loop through each group and each outcome
for (group in names(event_study_specs)) {
data_used <- event_study_specs[[group]]$data
ref_year <- event_study_specs[[group]]$ref
cat("\n=============================\n")
cat(paste("Group:", group, "- Reference Year:", ref_year, "\n"))
cat("=============================\n")
for (outcome_var in names(outcomes)) {
model_name <- paste0("event_study_", group, "_", outcome_var)
cat(paste0("\n>> Estimating: ", outcomes[[outcome_var]], "\n"))
model <- feols(
as.formula(paste0(outcome_var, " ~ i(year, Treated, ref = ", ref_year, ") | State_Acronym + year")),
data = data_used,
cluster = ~State_Acronym
)
print(summary(model))
}
}
#loop for the TWFE and DiD estimates for
# --- Loop to estimate TWFE and Simple DiD for log_RNCTR and real_log_nci ---
# Define outcomes and groups
outcomes <- c("log_RNCTR", "real_log_nci")
group_names <- c("2006", "2007", "0607")
group_filters <- list(
`2006` = c(2006, 2015, 2016, 2017, 2018),
`2007` = c(2007, 2015, 2016, 2017, 2018),
`0607` = c(2006, 2007, 2015, 2016, 2017, 2018)
)
reference_years <- list(`2006` = 2005, `2007` = 2006, `0607` = 2006)
# Storage lists
twfe_models <- list()
did_models <- list()
event_models <- list()
# Loop over outcomes and groups
for (outcome in outcomes) {
for (group in group_names) {
# Prepare data
data_filtered <- data %>%
filter(year_effective %in% group_filters[[group]],
year >= 1990, year <= 2014) %>%
mutate(
Treated = ifelse(group == "0607", year_effective %in% c(2006, 2007),
year_effective == as.numeric(group)),
Post = ifelse(year >= year_effective, 1, 0),
DiD = Treated * Post
)
# Estimate TWFE
model_twfe <- feols(
as.formula(paste(outcome, "~ Post | State_Acronym + year")),
data = data_filtered,
cluster = ~State_Acronym
)
# Estimate Simple DiD
model_did <- feols(
as.formula(paste(outcome, "~ Treated + Post + DiD")),
data = data_filtered
)
# Estimate Event-Study
model_event <- feols(
as.formula(paste(outcome, "~ i(year, Treated, ref =", reference_years[[group]], ") | State_Acronym + year")),
data = data_filtered,
cluster = ~State_Acronym
)
# Save models using consistent naming
twfe_models[[paste0("model_twfe_", group, "_", outcome)]] <- model_twfe
did_models[[paste0("model_did_", group, "_", outcome)]] <- model_did
event_models[[paste0("event_study_", group, "_", outcome)]] <- model_event
# Print summaries
cat("\n==============================\n")
cat("Group:", group, "- Outcome:", outcome, "\n")
cat("==============================\n")
cat("\n>> TWFE Model\n")
print(summary(model_twfe, cluster = "State_Acronym"))
cat("\n>> Simple DiD Model\n")
print(summary(model_did))
}
}
# --- Loop to estimate TWFE and Simple DiD for log_RNCTR and real_log_nci ---
# Define outcomes and groups
outcomes <- c("log_RNCTR", "real_log_nci")
group_names <- c("g2006", "g2007", "g0607")
# Use character names for clarity
group_filters <- list(
g2006 = c(2006, 2015, 2016, 2017, 2018),
g2007 = c(2007, 2015, 2016, 2017, 2018),
g0607 = c(2006, 2007, 2015, 2016, 2017, 2018)
)
reference_years <- list(
g2006 = 2005,
g2007 = 2006,
g0607 = 2006
)
# Storage lists
twfe_models <- list()
did_models <- list()
event_models <- list()
# Loop over outcomes and groups
for (outcome in outcomes) {
for (group in group_names) {
# Group ID for labeling
group_label <- gsub("g", "", group)
# Prepare data
data_filtered <- data %>%
filter(year_effective %in% group_filters[[group]],
year >= 1990, year <= 2014) %>%
mutate(
Treated = ifelse(
group == "g0607",
year_effective %in% c(2006, 2007),
year_effective == as.numeric(group_label)
),
Post = ifelse(year >= year_effective, 1, 0),
DiD = Treated * Post
)
# Estimate TWFE
model_twfe <- feols(
as.formula(paste(outcome, "~ Post | State_Acronym + year")),
data = data_filtered,
cluster = ~State_Acronym
)
# Estimate Simple DiD
model_did <- feols(
as.formula(paste(outcome, "~ Treated + Post + DiD")),
data = data_filtered
)
# Estimate Event-Study
model_event <- feols(
as.formula(paste(outcome, "~ i(year, Treated, ref =", reference_years[[group]], ") | State_Acronym + year")),
data = data_filtered,
cluster = ~State_Acronym
)
# Save models using informative names
twfe_models[[paste0("model_twfe_", group_label, "_", outcome)]] <- model_twfe
did_models[[paste0("model_did_", group_label, "_", outcome)]] <- model_did
event_models[[paste0("event_study_", group_label, "_", outcome)]] <- model_event
# Print summaries
cat("\n==============================\n")
cat("Group:", group_label, "- Outcome:", outcome, "\n")
cat("==============================\n")
cat("\n>> TWFE Model\n")
print(summary(model_twfe, cluster = "State_Acronym"))
cat("\n>> Simple DiD Model\n")
print(summary(model_did))
}
}
#now estimate the other NCR and proxy CI for 06.07
# --- TWFE model for Non-Corporate Tax Revenue
model_twfe_0607_log_RNCTR <- feols(log_RNCTR ~ Post | State_Acronym + year,
data = data_0607,
cluster = ~State_Acronym)
# --- Simple DiD model for Non-Corporate Tax Revenue
model_did_0607_log_RNCTR <- feols(log_RNCTR ~ Treated + Post + DiD,
data = data_0607)
# --- TWFE model for Proxy Corporate Income
model_twfe_0607_real_log_nci <- feols(real_log_nci ~ Post | State_Acronym + year,
data = data_0607,
cluster = ~State_Acronym)
# --- Simple DiD model for Proxy Corporate Income
model_did_0607_real_log_nci <- feols(real_log_nci ~ Treated + Post + DiD,
data = data_0607)
# Summary for TWFE model: log_RNCTR (Non-Corporate Tax Revenue)
summary(model_twfe_0607_log_RNCTR, cluster = "State_Acronym")
# Summary for Simple DiD model: log_RNCTR
summary(model_did_0607_log_RNCTR)
# Summary for TWFE model: real_log_nci (Proxy Corporate Income)
summary(model_twfe_0607_real_log_nci, cluster = "State_Acronym")
# Summary for Simple DiD model: real_log_nci
summary(model_did_0607_real_log_nci)
### NOW PLOTS FOR 06.07
library(fixest)
library(ggplot2)
library(dplyr)
library(broom)
# Define outcomes and labels
outcomes <- c("logRealCitRev", "log_RNCTR", "real_log_nci")
titles <- c(
"Log Corporate Tax Revenue",
"Log Non-Corporate Tax Revenue",
"Log Proxy Corporate Income"
)
# Loop through each outcome
for (i in seq_along(outcomes)) {
outcome <- outcomes[i]
title <- titles[i]
treatment_year <- 2006
group <- "Treated vs. Control"
# ---- Step 1: Treated vs. Control Average Plot ----
plot_data <- data_0607 %>%
mutate(Treatment = ifelse(year_effective %in% c(2006, 2007), "Treated", "Control")) %>%
group_by(year, Treatment) %>%
summarise(Mean = mean(.data[[outcome]], na.rm = TRUE), .groups = "drop")
p1 <- ggplot(plot_data, aes(x = year, y = Mean, color = Treatment)) +
geom_line(size = 1) + geom_point(size = 2) +
geom_vline(xintercept = treatment_year, linetype = "dashed", color = "black", size = 1) +
labs(
title = paste(group, ":", title),
x = "Year",
y = paste("Average", title)
) +
theme_minimal()
ggsave(
filename = paste0("0607_trend_", outcome, ".png"),
plot = p1, width = 6, height = 4, units = "in", dpi = 300
)
# ---- Step 2: Event Study Plot ----
model <- feols(
as.formula(paste0(outcome, " ~ i(year, Treated, ref = 2006) | State_Acronym + year")),
data = data_0607,
cluster = ~State_Acronym
)
coef_df <- tidy(model, conf.int = TRUE) %>%
filter(grepl("year::", term)) %>%
mutate(
year = as.numeric(gsub("year::", "", gsub(":Treated", "", term))),
sig = case_when(
p.value < 0.01 ~ "***",
p.value < 0.05 ~ "**",
p.value < 0.1  ~ "*",
TRUE ~ ""
)
)
p2 <- ggplot(coef_df, aes(x = year, y = estimate)) +
geom_point(size = 2) +
geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.25) +
geom_vline(xintercept = 2006, linetype = "dashed", color = "red") +
geom_hline(yintercept = 0, color = "black") +
labs(
title = paste("Event Study:", title),
x = "Year",
y = "Coefficient Estimate"
) +
theme_minimal()
ggsave(
filename = paste0("0607_event_", outcome, ".png"),
plot = p2, width = 6, height = 4, units = "in", dpi = 300
)
}
# Define outcomes and labels
outcomes <- c("logRealCitRev", "log_RNCTR", "real_log_nci")
titles <- c(
"Log Corporate Tax Revenue",
"Log Non-Corporate Tax Revenue",
"Log Proxy Corporate Income"
)
# Loop through each outcome
for (i in seq_along(outcomes)) {
outcome <- outcomes[i]
title <- titles[i]
treatment_year <- 2006
group <- "Treated vs. Control"
# ---- Step 1: Treated vs. Control Average Plot ----
plot_data <- data_0607 %>%
mutate(Treatment = ifelse(year_effective %in% c(2006, 2007), "Treated", "Control")) %>%
group_by(year, Treatment) %>%
summarise(Mean = mean(.data[[outcome]], na.rm = TRUE), .groups = "drop")
p1 <- ggplot(plot_data, aes(x = year, y = Mean, color = Treatment)) +
geom_line(linewidth = 1) + geom_point(size = 2) +
geom_vline(xintercept = treatment_year, linetype = "dashed", color = "black", size = 1) +
labs(
title = paste(group, ":", title),
x = "Year",
y = paste("Average", title)
) +
theme_minimal()
ggsave(
filename = paste0("0607_trend_", outcome, ".png"),
plot = p1, width = 6, height = 4, units = "in", dpi = 300
)
# ---- Step 2: Event Study Plot ----
model <- feols(
as.formula(paste0(outcome, " ~ i(year, Treated, ref = 2006) | State_Acronym + year")),
data = data_0607,
cluster = ~State_Acronym
)
coef_df <- tidy(model, conf.int = TRUE) %>%
filter(grepl("year::", term)) %>%
mutate(
year = as.numeric(gsub("year::", "", gsub(":Treated", "", term))),
sig = case_when(
p.value < 0.01 ~ "***",
p.value < 0.05 ~ "**",
p.value < 0.1  ~ "*",
TRUE ~ ""
)
)
p2 <- ggplot(coef_df, aes(x = year, y = estimate)) +
geom_point(size = 2) +
geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.25) +
geom_vline(xintercept = 2006, linetype = "dashed", color = "red") +
geom_hline(yintercept = 0, color = "black") +
labs(
title = paste("Event Study:", title),
x = "Year",
y = "Coefficient Estimate"
) +
theme_minimal()
ggsave(
filename = paste0("0607_event_", outcome, ".png"),
plot = p2, width = 6, height = 4, units = "in", dpi = 300
)
}
View(data)
