#Attempt to Get Revenue in R
install.packages("readxl")
install.packages("tidyr")
install.packages("dplyr")
install.packages("did")
install.packages("tidyverse")
install.packages("lmtest")
library(readxl)
library(tidyr)
library(dplyr)
library(did)
library(tidyverse)
library(lmtest)
Census State and Local Data- Tax Foundation
# Census State and Local Data- Tax Foundation
install.packages("readxl")
install.packages("tidyr")
install.packages("dplyr")
install.packages("tidyverse")
install.packages("xlsx")
library(readxl)
library(tidyr)
library(dplyr)
library(tidyverse)
library(xlsx)
#Nebraska or "Direct Switchers DiD Approach"
#Run DiD with all the Direct Switchers (NE, MO, MS, CO, RI, ND, DE)
#Control Group is all States that Did not Switch by 2007.
#this includes: AK, HI, KS, NM, OK.  AL and MT between 2008-now became "Step
#-wise" switchers.  FL and MA had DWS over the whole period 1976-2022.
library(tidyr)
library(dplyr)
library(tidyverse)
# for robust standard error estimation
library(lmtest)
# To calculate correct vcov matrix with 2WFE
library(multiwayvcov)
# For a package way to do FE
library(plm)
#Fixest
install.packages("fixest")
library(fixest)
#Load Data Tables in R
install.packages("data.table")
# Get rate of change for tax bases and find elasticity of tax base w.r.t apportionment and rate changes.
#Redo Callaway and Sant'Anna From Summer
library(readxl)
library(tidyr)
library(dplyr)
library(did)
library(tidyverse)
library(lmtest)
library(caret)
library(ggplot2)
#New Directory
setwd("~/Documents/GitHub/ST_Apportionment/Rates_Of_Change")
#Load Packages
library(tidyr)
library(dplyr)
library(tidyverse)
library(lmtest)
library(ggplot2)
library(did) # for running DiD
library(plm)
library(lmtest)
library(synthdid)
library(fixest)
set.seed(26)
#JMP Directory
setwd("~/Documents/GitHub/ST-Apportionment/job_market_data")
#Load Detrended, per capita, real revenue data
Rev <- read.csv("detrend_per_capita.csv")
#Remove X and X.1, REMOVE COLUMN when saving
#note, row names =FALSE did not work, still have an X
Rev <- Rev %>%
select(-X,-X.1)
#Block treatment Archangelsky SynDiD for just Indiana and all states that don't
#switch before 2014.  Merge back together
Ind <-Rev %>%
filter(State_Acronym=="IN")
Control <- Rev %>%
filter(year_effective>2014 | is.na(year_effective))
df <- Ind %>%
bind_rows(Control)
#Now want to filter the df to just be until 2014
df2 <- df %>%
filter(year<=2014)
filter_total <- df2 %>%
select(State_Acronym,year,real_totRev_capita,treatment)
unique_states <- unique(filter_total$State_Acronym)
sum(is.na(filter_total))
# Transform to N*T matrix format required for synthdid,
# where N is the number of units and T the time periods.
#setup <- panel.matrices(filter_total, unit = "State_Acronym", time = "year", outcome = "real_totRev_capita", treatment = "treatment")
setup <- panel.matrices(filter_total,unit = "State_Acronym", time = "year", outcome = "real_totRev_capita", treatment = "treatment")
# Transform to N*T matrix format required for synthdid,
# where N is the number of units and T the time periods.
#setup <- panel.matrices(filter_total, unit = "State_Acronym", time = "year", outcome = "real_totRev_capita", treatment = "treatment")
setup <- panel.matrices(as.data.frame(as_tibble(filter_total)),unit = "State_Acronym", time = "year", outcome = "real_totRev_capita", treatment = "treatment")
View(filter_total)
data("filter_total")
head(filter_total)
setup <-panel.matrices(filter_total)
pdata <- pdata.frame(filter_total, index = c("State_Acronym", "year"))
is_balanced <- is.pbalanced(pdata)
print(is_balanced)
complete_panel <- expand.grid(State_Acronym = unique(filter_total$State_Acronym),
year = seq(min(filter_total$year), max(filter_total$year)))
# Merge with your data to find missing combinations
merged_data <- merge(complete_panel, filter_total, by = c("State_Acronym", "year"), all.x = TRUE)
# Identify missing values
missing_data <- merged_data[is.na(merged_data$real_totRev_capita), ]
print(missing_data)
View(missing_data)
View(merged_data)
View(merged_data)
#Now want to filter the df to just be until 2014
df2 <- df %>%
filter(year<=2013)
filter_total <- df2 %>%
select(State_Acronym,year,real_totRev_capita,treatment)
filter_total2 <- df2 %>%
select(State_Acronym,year,real_totRev_capita,treatment)
#check balance on filter_total2
pdata2 <- pdata.frame(filter_total2, index = c("State_Acronym", "year"))
#check balance
is_balanced2 <- is.pbalanced(pdata2)
print(is_balanced2)
#TRUE
#Full steam ahead with https://synth-inference.github.io/synthdid/
setup <- panel.matrices(filter_total2,unit = "State_Acronym", time = "year", outcome = "real_totRev_capita", treatment = "treatment")
tau.hat = synthdid_estimate(setup$real_totRev_capita, setup$N0, setup$T0)
tau.hat = synthdid_estimate(setup$Y, setup$N0, setup$T0)
se = sqrt(vcov(tau.hat, method='placebo'))
sprintf('point estimate: %1.2f', tau.hat)
sprintf('95%% CI (%1.2f, %1.2f)', tau.hat - 1.96 * se, tau.hat + 1.96 * se)
plot(tau.hat)
print(summary(tau.hat))
#control unit contribution plot
synthdid_units_plot(tau.hat, se.method='placebo')
#checking for pre-treatment and parallel trends
plot(tau.hat, overlay=1,  se.method='placebo')
#shift control's trajectory towards California
plot(tau.hat, overlay=.8, se.method='placebo')
#Compare the SynDiD to other estimators
tau.sc   = sc_estimate(setup$Y, setup$N0, setup$T0)
tau.did  = did_estimate(setup$Y, setup$N0, setup$T0)
estimates = list(tau.did, tau.sc, tau.hat)
names(estimates) = c('Diff-in-Diff', 'Synthetic Control', 'Synthetic Diff-in-Diff')
#print estimate differences:
print(unlist(estimates))
#the plots relative to each other
synthdid_plot(estimates, se.method='placebo')
#Synthetic control units plot
synthdid_units_plot(estimates, se.method='placebo')
#Customize the plots
synthdid_plot(estimates, facet.vertical=FALSE,
control.name='control', treated.name='california',
lambda.comparable=TRUE, se.method = 'none',
trajectory.linetype = 1, line.width=.75, effect.curvature=-.4,
trajectory.alpha=.7, effect.alpha=.7,
diagram.alpha=1, onset.alpha=.7) +
theme(legend.position=c(.26,.07), legend.direction='horizontal',
legend.key=element_blank(), legend.background=element_blank(),
strip.background=element_blank(), strip.text.x = element_blank())
#Customize the plots
synthdid_plot(estimates, facet.vertical=FALSE,
control.name='control', treated.name='Indiana',
lambda.comparable=TRUE, se.method = 'none',
trajectory.linetype = 1, line.width=.75, effect.curvature=-.4,
trajectory.alpha=.7, effect.alpha=.7,
diagram.alpha=1, onset.alpha=.7) +
theme(legend.position=c(.26,.07), legend.direction='horizontal',
legend.key=element_blank(), legend.background=element_blank(),
strip.background=element_blank(), strip.text.x = element_blank())
#spaghetti plots
estimate = synthdid_estimate(setup$Y, setup$N0, setup$T0)
top.controls = synthdid_controls(estimate)[1:10, , drop=FALSE]
plot(estimate, spaghetti.units=rownames(top.controls))
plot(estimate, spaghetti.units=rownames(top.controls)) + labs(x="Year",y="Real Total Revenue per Capita")
plot(estimate, spaghetti.units=rownames(top.controls)) + labs(x="Year",y="Real Total Revenue per Capita") + ggtitle("Synthetic DiD PLot- Indiana")
plot(estimate, spaghetti.units=rownames(top.controls)) + labs(x="Year",y="Real Total Revenue per Capita") + ggtitle("Synthetic DiD Plot- Indiana")
plot(estimate, spaghetti.units=rownames(top.controls)) + labs(x="Year",y="Real Total Revenue per Capita") + ggtitle("Synthetic DiD Spaghetti Plot- Indiana")
plot(tau.hat)+labs(x="Year",y="Real Total Revenue per Capita") + ggtitle("Synthetic DiD Plot- Indiana = Treated")
#control unit contribution plot
synthdid_units_plot(tau.hat, se.method='placebo') + +labs(x="Control States") + ggtitle("Unit Contribution Plot- Syn DiD Indiana")
#control unit contribution plot
synthdid_units_plot(tau.hat, se.method='placebo') + +labs(x="Control States",y="Real Total Revenue per Capita") + ggtitle("Unit Contribution Plot- Syn DiD Indiana")
#control unit contribution plot
synthdid_units_plot(tau.hat, se.method='placebo') +labs(x="Control States",y="Real Total Revenue per Capita") + ggtitle("Unit Contribution Plot- Syn DiD Indiana")
#control unit contribution plot
synthdid_units_plot(tau.hat, se.method='placebo') +labs(x="Control States") + ggtitle("Unit Contribution Plot- Syn DiD Indiana")
#checking for pre-treatment and parallel trends
plot(tau.hat, overlay=1,  se.method='placebo') +labs(x="Control States",y="Real Total Revenue per Capita") + ggtitle("Pre-Treatment and Parallel Trends Plot- Syn DiD Indiana")
#shift control's trajectory towards Indiana
plot(tau.hat, overlay=.8, se.method='placebo') +labs(x="Control States",y="Real Total Revenue per Capita") + ggtitle("Shift Control Trajectory Towards Indiana Plot- Syn DiD Indiana")
#checking for pre-treatment and parallel trends
plot(tau.hat, overlay=1,  se.method='placebo') +labs(x="Year",y="Real Total Revenue per Capita") + ggtitle("Pre-Treatment and Parallel Trends Plot- Syn DiD Indiana")
#shift control's trajectory towards Indiana
plot(tau.hat, overlay=.8, se.method='placebo') +labs(x="Year",y="Real Total Revenue per Capita") + ggtitle("Shift Control Trajectory Towards Indiana Plot- Syn DiD Indiana")
#Customize the plots
synthdid_plot(estimates, facet.vertical=FALSE,
control.name='control', treated.name='Indiana',
lambda.comparable=TRUE, se.method = 'none',
trajectory.linetype = 1, line.width=.75, effect.curvature=-.4,
trajectory.alpha=.7, effect.alpha=.7,
diagram.alpha=1, onset.alpha=.7) +
theme(legend.position=c(.26,.07), legend.direction='horizontal',
legend.key=element_blank(), legend.background=element_blank(),
strip.background=element_blank(), strip.text.x = element_blank())
#Synthetic control units plot
synthdid_units_plot(estimates, se.method='placebo')+labs(x="Year",y="Real Total Revenue per Capita") + ggtitle("DiD v. Syn Control v. Syn DiD Plot- Syn DiD Indiana")
#the plots relative to each other
synthdid_plot(estimates, se.method='placebo')+labs(x="Year",y="Real Total Revenue per Capita") + ggtitle("DiD v. Syn Control v. Syn DiD Plot- Syn DiD Indiana")
#Attempt to make top controls darker
ggplot(data, aes(x = year, y = real_totRev_capita, group = State_Acronym)) +
geom_line(aes(color = is_top_control, alpha = is_top_control, size = is_top_control)) +
scale_color_manual(values = c("TRUE" = "black", "FALSE" = "grey")) +
scale_alpha_manual(values = c("TRUE" = 1, "FALSE" = 0.5)) +
scale_size_manual(values = c("TRUE" = 1, "FALSE" = 0.5)) +
labs(x = "Year", y = "Real Total Revenue per Capita") +
ggtitle("Synthetic DiD Spaghetti Plot - Indiana") +
theme_minimal()
#Attempt to make top controls darker
ggplot(estimate, aes(x = year, y = real_totRev_capita, group = State_Acronym)) +
geom_line(aes(color = is_top_control, alpha = is_top_control, size = is_top_control)) +
scale_color_manual(values = c("TRUE" = "black", "FALSE" = "grey")) +
scale_alpha_manual(values = c("TRUE" = 1, "FALSE" = 0.5)) +
scale_size_manual(values = c("TRUE" = 1, "FALSE" = 0.5)) +
labs(x = "Year", y = "Real Total Revenue per Capita") +
ggtitle("Synthetic DiD Spaghetti Plot - Indiana") +
theme_minimal()
#Attempt to make top controls darker
plot(estimate, aes(x = year, y = real_totRev_capita, group = State_Acronym)) +
geom_line(aes(color = is_top_control, alpha = is_top_control, size = is_top_control)) +
scale_color_manual(values = c("TRUE" = "black", "FALSE" = "grey")) +
scale_alpha_manual(values = c("TRUE" = 1, "FALSE" = 0.5)) +
scale_size_manual(values = c("TRUE" = 1, "FALSE" = 0.5)) +
labs(x = "Year", y = "Real Total Revenue per Capita") +
ggtitle("Synthetic DiD Spaghetti Plot - Indiana") +
theme_minimal()
plot(estimate, spaghetti.units=rownames(top.controls)). + labs(x="Year",y="Real Total Revenue per Capita") + ggtitle("Synthetic DiD Spaghetti Plot- Indiana")+scale_alpha_manual(values = c("TRUE" = 1, "FALSE" = 0.5))
plot(estimate, spaghetti.units=rownames(top.controls)) + labs(x="Year",y="Real Total Revenue per Capita") + ggtitle("Synthetic DiD Spaghetti Plot- Indiana")+scale_alpha_manual(values = c("TRUE" = 1, "FALSE" = 0.5))
#Attempt to make top controls darker
base_plot <-plot(estimate, spaghetti.units=rownames(top.controls)) + labs(x="Year",y="Real Total Revenue per Capita") + ggtitle("Synthetic DiD Spaghetti Plot- Indiana")
# Add ggplot2 layers to customize
base_plot +
labs(x = "Year", y = "Real Total Revenue per Capita") +
ggtitle("Synthetic DiD Spaghetti Plot - Indiana") +
theme_minimal() +
scale_color_manual(values = c("TRUE" = "black", "FALSE" = "grey")) +
scale_size_manual(values = c("TRUE" = 1, "FALSE" = 0.5))
#save csv for just Indiana
write.csv(filter_total2,"Indiana_sDiD.csv")
#Block treatment Archangelsky SynDiD for just 2007 switch and all states that don't
#switch before 2013.  Merge back together
Switcher07 <-Rev %>%
filter(year_effective==2007)
View(Switcher07)
Control2 <- Rev %>%
filter(year_effective>2014 | is.na(year_effective))
df <- Switcher07 %>%
bind_rows(Control2)
#Now want to filter the df to just be until 2014
df2 <- df %>%
filter(year<=2013)
filter_total3 <- df2 %>%
select(State_Acronym,year,real_totRev_capita,treatment)
View(filter_total3)
#Check that the panel is balanced
pdata1 <- pdata.frame(filter_total3, index = c("State_Acronym", "year"))
#check balance
is_balanced1 <- is.pbalanced(pdata1)
print(is_balanced1)
#Balanced, full speed ahead.
#save df for 2007 switchers
write.csv(filter_total3,"2007_Switchers_sDiD.csv")
setup1 <- panel.matrices(filter_total3,unit = "State_Acronym", time = "year", outcome = "real_totRev_capita", treatment = "treatment")
tau.hat = synthdid_estimate(setup1$Y, setup1$N0, setup1$T0)
se = sqrt(vcov(tau.hat, method='placebo'))
sprintf('point estimate: %1.2f', tau.hat)
sprintf('95%% CI (%1.2f, %1.2f)', tau.hat - 1.96 * se, tau.hat + 1.96 * se)
plot(tau.hat)+labs(x="Year",y="Real Total Revenue per Capita") + ggtitle("Synthetic DiD Plot- 2007 Switchers = Treated")
#Summary stats for Indiana Syn control group
print(summary(tau.hat))
#control unit contribution plot
synthdid_units_plot(tau.hat, se.method='placebo') +labs(x="Control States") + ggtitle("Unit Contribution Plot- 2007 Switchers")
#checking for pre-treatment and parallel trends
plot(tau.hat, overlay=1,  se.method='placebo') +labs(x="Year",y="Real Total Revenue per Capita") + ggtitle("Pre-Treatment and Parallel Trends Plot- 2007 Switchers")
#shift control's trajectory towards Indiana
plot(tau.hat, overlay=.8, se.method='placebo') +labs(x="Year",y="Real Total Revenue per Capita") + ggtitle("Shift Control Trajectory Towards Indiana Plot- 2007 Switchers")
#Compare the SynDiD to other estimators, set-up
tau.sc   = sc_estimate(setup1$Y, setup1$N0, setup1$T0)
tau.did  = did_estimate(setup1$Y, setup1$N0, setup1$T0)
estimates = list(tau.did, tau.sc, tau.hat)
names(estimates) = c('Diff-in-Diff', 'Synthetic Control', 'Synthetic Diff-in-Diff')
#print estimate differences:
print(unlist(estimates))
#the plots relative to each other
synthdid_plot(estimates, se.method='placebo')+labs(x="Year",y="Real Total Revenue per Capita") + ggtitle("DiD v. Syn Control v. Syn DiD Plot- Syn 2007 Switchers")
#Synthetic control units plot
synthdid_units_plot(estimates, se.method='placebo')
#spaghetti plots, includes all states for just Indiana
estimate = synthdid_estimate(setup1$Y, setup1$N0, setup1$T0)
top.controls = synthdid_controls(estimate)[1:10, , drop=FALSE]
plot(estimate, spaghetti.units=rownames(top.controls)) + labs(x="Year",y="Real Total Revenue per Capita") + ggtitle("Synthetic DiD Spaghetti Plot- 2007 Switchers")
