#Attempt to Get Revenue in R
install.packages("readxl")
install.packages("tidyr")
install.packages("dplyr")
install.packages("did")
install.packages("tidyverse")
install.packages("lmtest")
library(readxl)
library(tidyr)
library(dplyr)
library(did)
library(tidyverse)
library(lmtest)
Census State and Local Data- Tax Foundation
# Census State and Local Data- Tax Foundation
install.packages("readxl")
install.packages("tidyr")
install.packages("dplyr")
install.packages("tidyverse")
install.packages("xlsx")
library(readxl)
library(tidyr)
library(dplyr)
library(tidyverse)
library(xlsx)
#Nebraska or "Direct Switchers DiD Approach"
#Run DiD with all the Direct Switchers (NE, MO, MS, CO, RI, ND, DE)
#Control Group is all States that Did not Switch by 2007.
#this includes: AK, HI, KS, NM, OK.  AL and MT between 2008-now became "Step
#-wise" switchers.  FL and MA had DWS over the whole period 1976-2022.
library(tidyr)
library(dplyr)
library(tidyverse)
# for robust standard error estimation
library(lmtest)
# To calculate correct vcov matrix with 2WFE
library(multiwayvcov)
# For a package way to do FE
library(plm)
#Fixest
install.packages("fixest")
library(fixest)
#Load Data Tables in R
install.packages("data.table")
# Get rate of change for tax bases and find elasticity of tax base w.r.t apportionment and rate changes.
#Redo Callaway and Sant'Anna From Summer
library(readxl)
library(tidyr)
library(dplyr)
library(did)
library(tidyverse)
library(lmtest)
library(caret)
library(ggplot2)
#New Directory
setwd("~/Documents/GitHub/ST_Apportionment/Rates_Of_Change")
# set seed
set.seed(26)
#JMP Directory
setwd("~/Documents/GitHub/ST-Apportionment/job_market_data")
#Load Packages
library(tidyr)
library(dplyr)
library(tidyverse)
library(lmtest)
library(ggplot2)
library(readxl) #load ssfa switch date
library(did) # for running DiD
library(caret)
library(plm) # for Two way FE
library(fixest) # multiple FE
library(broom) #extract coefficients for each state
#
#Load Data, Coefficient Plot & Rev Data for estimates
Coef <-read.csv("state_post_dummy_total_rev._6_15_24.csv")
Rev <-read.csv("revenue_panel_total_rev_state_coef_result_6_15_24.csv")
View(Rev)
CPI < read.xlsx("cpi.xlsx",sheet=CPI)
CPI < read.xlsx("cpi.xlsx")
CPI <-read.xlsx("cpi.xlsx")
CPI <-read.xls("cpi.xlsx")
library(readxl) #load ssfa switch date
CPI <-read.xls("cpi.xlsx")
install.packages("readxl")
install.packages("readxl")
library(tidyr)
library(dplyr)
library(tidyverse)
library(lmtest)
library(ggplot2)
install.packages("readxl")
library(readxl) #load ssfa switch date
library(did) # for running DiD
library(caret)
library(plm) # for Two way FE
library(fixest) # multiple FE
library(broom) #extract coefficients for each state
# set seed
set.seed(26)
#JMP Directory
setwd("~/Documents/GitHub/ST-Apportionment/job_market_data")
#Load Data, Coefficient Plot & Rev Data for estimates
Coef <-read.csv("state_post_dummy_total_rev._6_15_24.csv")
Rev <-read.csv("revenue_panel_total_rev_state_coef_result_6_15_24.csv")
CPI <-read.xls("cpi.xlsx")
CPI <- read_xls("cpi.xlsx")
CPI <- read_xls("cpi.xlsx")
CPI <- read_excel("/Users/ben/Documents/GitHub/ST-Apportionment/job_market_data/cpi.xlsx")
View(CPI)
View(Coef)
View(Rev)
View(Coef)
Rev <-Rev %>%
select(-X)
Log_rev <- Log_rev %>%
select(-X)
View(CPI)
#Merge CPI and Rev
Rev1 <- Rev %>%
full_join(CPI,by=c("year"="Year"))
View(Rev1)
#save Revenue with CPI
write.csv(Rev1,"revenues_cpi_6_17_24.csv")
#Just create real revenue for Total Revenue
Rev2 <- Rev1 %>%
mutate(real_totRev = TOTLTAX/CPI)
#Just create real revenue for Total Revenue
Rev2 <- Rev1 %>%
mutate(real_totRev = TOTLTAX/Annual)
View(Rev2)
#rename annual column to CPI
Rev3 <- Rev2 %>%
rename(Rev2, Annual=CPI)
#rename annual column to CPI
Rev3 <- Rev2 %>%
rename(Annual=CPI)
#rename annual column to CPI
Rev3 <- Rev2 %>%
rename(Annual=CPI_def)
#rename annual column to CPI
Rev3 <- Rev2 %>%
rename(CPI_def=Annual)
View(Rev3)
write.csv(Rev3,"revenue_cpi_total.csv")
Rev2 <- Rev1 %>%
mutate(real_totRev = (TOTLTAX/Annual)*100)
#rename annual column to CPI
Rev3 <- Rev2 %>%
rename(CPI_def=Annual)
write.csv(Rev3,"revenue_cpi_total.csv")
View(Rev3)
#Run the Two way FE regression again, except, do it with Real Revenue, loaded in Rev 3
Rev4 <- Rev3 %>%
mutate(logRealTotRev=log(real_totRev))
#Simple regression, real revenue
Simple_reg <- lm(logRealTotRev ~ Post + factor(year) + factor(state), Rev4)
summary(Simple_reg)
# Interaction Reg (with interaction between Post and state)
Interaction_Realreg <- lm(logRealTotRev ~ Post * factor(State_Name) + factor(year), data = Rev4)
summary(Interaction_Realreg)
# It is close, just trying to get Alabama
# Set Alabama as the reference category
Rev4$State_Name <- relevel(factor(Rev4$State_Name), ref = "Alabama")
# Interaction Reg (with interaction between Post and state)
Interaction_Realreg2 <- lm(logRealTotRev ~ Post * factor(State_Name) + factor(year), data = Rev4)
summary(Interaction_Realreg2)
#Extract coefficients for each state using Broom
tidy_model <- tidy(Interaction_Realreg2)
# Filter the coefficients to get only those related to Post
post_coefficients <- tidy_model %>%
filter(grepl("Post", term))
print(post_coefficients)
#Extracting the post coefficient for each state
fit_state_model <- function(df) {
lm(log_RealTotrev ~ Post + factor(year), data = df)
}
#Extracting the post coefficient for each state
fit_state_model <- function(df) {
lm(log_RealTotrev ~ Post + factor(year), data = Rev4)
}
# Split data by state and fit model for each state
state_models <- Rev4 %>%
group_by(State_Name) %>%
group_map(~ fit_state_model(.x))
#Extracting the post coefficient for each state
fit_state_model <- function(df) {
lm(logRealTotRev ~ Post + factor(year), data = Rev4)
}
# Split data by state and fit model for each state
state_models <- Rev4 %>%
group_by(State_Name) %>%
group_map(~ fit_state_model(.x))
# Extract coefficients for Post from each model
post_coeffs <- lapply(state_models, function(model) {
tidy(model) %>% filter(term == "Post")
})
# Combine results into a single data frame
post_coeffs_df <- bind_rows(post_coeffs, .id = "State_Name")
print(post_coeffs_df)
#Attempt to dissaggregate the results from the Alabama coefficient
# Set Alabama as the reference category
Rev4$State_Name <- relevel(factor(Rev4$State_Name), ref = "Alabama")
# Interaction regression with interaction between Post and state, more explanation needs to be given for this interaction in github note.
interaction_model <- lm(logRealTotRev ~ Post * factor(State_Name) + factor(year), data = Rev4)
summary(interaction_model)
# Extract coefficients for each state using Broom
tidy_interaction_model <- tidy(interaction_model)
# Filter the coefficients to get only those related to Post
post_interaction_coefficients <- tidy_interaction_model %>%
filter(grepl("Post", term))
print(post_interaction_coefficients)
# Create a data frame for the Post coefficients for each state
post_coefficients_combined <- post_interaction_coefficients %>%
mutate(
State = ifelse(term == "Post", "Alabama", gsub("Post:factor\\(State_Name\\)", "", term)),
Post_Estimate = ifelse(term == "Post", estimate, estimate + post_interaction_coefficients$estimate[post_interaction_coefficients$term == "Post"]),
Post_Std_Error = std.error,
Post_Statistic = statistic,
Post_P_Value = p.value
) %>%
select(State, Post_Estimate, Post_Std_Error, Post_Statistic, Post_P_Value)
options(digits=9)
print(post_coefficients_combined, n= Inf)
View(post_coefficients_combined)
View(post_coefficients_combined)
#allowed for printing the dataframe to be converted more easily in Latex
print(
post_coefficients_combined %>%
mutate(across(where(is.numeric), ~ format(.x, digits = 6, scientific = FALSE))),
n = Inf
)
#Stata coefficient plot
install.packages("coefplot")
library(coefplot)
coefplot(interaction_model)
#Coef plot excluding coefficient
coefplot(interaction_model, exclude = "Intercept")
str(interaction_model)
#Coef plot excluding coefficient
coefplot(interaction_model, exclude = "(Intercept)")
#Coef plot excluding coefficient
coefplot(interaction_model, exclude = "(Intercept)")
summary(interaction_model)
#Coef plot excluding coefficient
coefplot(interaction_model, exclude = "(Intercept) ")
#Coef plot excluding coefficient
coefplot(interaction_model, exclude = "(Intercept)")
View(interaction_model)
# Specify the coefficients to include
coefficients_to_include <- c(
"factor(year)1977", "factor(year)1978", "factor(year)1979",
"factor(year)1980", "factor(year)1981", "factor(year)1982",
"factor(year)1983", "factor(year)1984", "factor(year)1985",
"factor(year)1986", "factor(year)1987", "factor(year)1988",
"factor(year)1989", "factor(year)1990", "factor(year)1991",
"factor(year)1992", "factor(year)1993", "factor(year)1994",
"factor(year)1995", "factor(year)1996", "factor(year)1997",
"factor(year)1998", "factor(year)1999", "factor(year)2000",
"factor(year)2001", "factor(year)2002", "factor(year)2003",
"factor(year)2004", "factor(year)2005", "factor(year)2006",
"factor(year)2007", "factor(year)2008", "factor(year)2009",
"factor(year)2010", "factor(year)2011", "factor(year)2012",
"factor(year)2013", "factor(year)2014", "factor(year)2015",
"factor(year)2016", "factor(year)2017", "factor(year)2018",
"factor(year)2019", "factor(year)2020", "factor(year)2021",
"factor(year)2022"
)
# Create the coefficient plot including only the specified coefficients
coefplot(model, include = coefficients_to_include)
# Create the coefficient plot including only the specified coefficients
coefplot(interaction_model, include = coefficients_to_include)
coef_subset <- coef_summary[rownames(coef_summary) %in% coefficients_to_include, ]
# Extract the coefficients
coef_summary <- summary(interaction_mode)$coefficients
# Extract the coefficients
coef_summary <- summary(interaction_model)$coefficients
coef_subset <- coef_summary[rownames(coef_summary) %in% coefficients_to_include, ]
# Custom function to plot subsetted coefficients
custom_coefplot <- function(coef_subset) {
estimates <- coef_subset[, 1]
errors <- coef_subset[, 2]
plot(
x = estimates,
y = 1:length(estimates),
xlim = range(estimates - 2*errors, estimates + 2*errors),
pch = 19,
xlab = "Estimate",
ylab = "Coefficient",
yaxt = "n"
)
axis(2, at = 1:length(estimates), labels = rownames(coef_subset), las = 2)
segments(
x0 = estimates - 2 * errors,
y0 = 1:length(estimates),
x1 = estimates + 2 * errors,
y1 = 1:length(estimates)
)
}
custom_coefplot(coef_subset)
# Plot the subsetted coefficients
coefplot(coef_subset)
# Create the coefficient plot including only the specified coefficients
coefplot(interaction_model, coefficients=c(coefficients_to_include))
# Create the coefficient plot including only the specified coefficients
coefplot(interaction_model, coefficients=c(coefficients_to_include), title= "Coefficient Plot for Year Fixed Effects")
View(post_interaction_coefficients)
View(post_coefficients_combined)
#State FE
coefficients_to_include_2 <- c(
"Post", "factor(State_Name)Alaska", "factor(State_Name)Arizona",
"factor(State_Name)Arkansas", "factor(State_Name)California",
"factor(State_Name)Colorado", "factor(State_Name)Connecticut",
"factor(State_Name)Delaware", "factor(State_Name)Florida",
"factor(State_Name)Georgia", "factor(State_Name)Hawaii",
"factor(State_Name)Idaho", "factor(State_Name)Illinois",
"factor(State_Name)Indiana", "factor(State_Name)Iowa",
"factor(State_Name)Kansas", "factor(State_Name)Kentucky",
"factor(State_Name)Louisiana", "factor(State_Name)Maine",
"factor(State_Name)Maryland", "factor(State_Name)Massachusetts",
"factor(State_Name)Michigan", "factor(State_Name)Minnesota",
"factor(State_Name)Mississippi", "factor(State_Name)Missouri",
"factor(State_Name)Montana", "factor(State_Name)Nebraska",
"factor(State_Name)New Hampshire", "factor(State_Name)New Jersey",
"factor(State_Name)New Mexico", "factor(State_Name)New York",
"factor(State_Name)North Carolina", "factor(State_Name)North Dakota",
"factor(State_Name)Ohio", "factor(State_Name)Oklahoma",
"factor(State_Name)Oregon", "factor(State_Name)Pennsylvania",
"factor(State_Name)Rhode Island", "factor(State_Name)South Carolina",
"factor(State_Name)Tennessee", "factor(State_Name)Utah",
"factor(State_Name)Vermont", "factor(State_Name)Virginia",
"factor(State_Name)West Virginia", "factor(State_Name)Wisconsin"
)
#State FE
coefplot(interaction_model, coefficients=c(coefficients_to_include_2), title= "Coefficient Plot for State Fixed Effects")
View(tidy_interaction_model)
View(post_interaction_coefficients)
plot_post_estimates <- function(df) {
estimates <- df$Post_Estimate
errors <- df$Post_SE
states <- df$State
# Plot the estimates
plot(
x = estimates,
y = 1:length(estimates),
xlim = range(estimates - 2*errors, estimates + 2*errors),
pch = 19,
xlab = "Post Estimate",
ylab = "State",
yaxt = "n",
main = "Post Estimates by State"
)
#Try to get the post coef
plot_post_estimates <- function(df) {
estimates <- df$Post_Estimate
errors <- df$Post_SE
states <- df$State
# Plot the estimates
plot(
x = estimates,
y = 1:length(estimates),
xlim = range(estimates - 2*errors, estimates + 2*errors),
pch = 19,
xlab = "Post Estimate",
ylab = "State",
yaxt = "n",
main = "Post Estimates by State"
)
# Add state labels on the y-axis
axis(2, at = 1:length(estimates), labels = states, las = 2)
# Add error bars
segments(
x0 = estimates - 2 * errors,
y0 = 1:length(estimates),
x1 = estimates + 2 * errors,
y1 = 1:length(estimates)
)
}
# Use the custom function to plot
plot_post_estimates(post_coefficients_combined)
#Try to get the post coef
plot_post_estimates <- function(df) {
estimates <- df$Post_Estimate
errors <- df$Post_SE
states <- df$State
# Plot the estimates
plot(
x = estimates,
y = 1:length(estimates),
xlim = range(estimates - 2*errors, estimates + 2*errors),
pch = 19,
xlab = "Post Estimate",
ylab = "State",
yaxt = "n",
main = "Post Estimates by State"
)
# Add state labels on the y-axis
axis(2, at = 1:length(estimates), labels = states, las = 2)
# Add error bars
segments(
x0 = estimates - 2 * errors,
y0 = 1:length(estimates),
x1 = estimates + 2 * errors,
y1 = 1:length(estimates)
)
}
# Use the custom function to plot
plot_post_estimates(post_coefficients_combined)
View(Rev1)
post_coefficients_combined %>%
ggplot(aes(Post_Estimate,State))%>%
geom_point() +
geom_vline(xintercept = 0, lty = 2) +
labs(x= "Value",
y= "Coefficient",
title= "Coefficient Plot for Policy by State")
#Load Packages
library(tidyr)
library(dplyr)
library(tidyverse)
library(lmtest)
library(ggplot2)
library(readxl) #load ssfa switch date
library(did) # for running DiD
library(caret)
library(plm) # for Two way FE
library(fixest) # multiple FE
library(broom) #extract coefficients for each state
post_coefficients_combined %>%
ggplot(aes(Post_Estimate,State))%>%
geom_point() +
geom_vline(xintercept = 0, lty = 2) +
labs(x= "Value",
y= "Coefficient",
title= "Coefficient Plot for Policy by State")
post_coefficients_combined %>%
ggplot(aes(x = Post_Estimate, y= State))%>%
geom_point() +
geom_vline(xintercept = 0, lty = 2) +
labs(x= "Value",
y= "Coefficient",
title= "Coefficient Plot for Policy by State")
post_coefficients_combined %>%
ggplot(aes(x = Post_Estimate, y= State))%>%
geom_point() +
geom_vline(xintercept = 0, lty = 2) +
labs(x= "Value",
y= "Coefficient",
title= "Coefficient Plot for Policy by State") +
theme_minimal()
post_coefficients_combined %>%
ggplot(aes(x = Post_Estimate, y = State)) +
geom_point() +
geom_vline(xintercept = 0, lty = 2) +
labs(x= "Value", y= "Coefficient", title= "Coefficient Plot for Policy by State") +
theme_minimal()
coefplot(interaction_model, coefficients=c(coefficients_to_include_2), title= "Coefficient Plot for State Fixed Effects") +
theme_minimal()
post_coefficients_combined %>%
ggplot(aes(x = Post_Estimate, y = State)) +
geom_point() +
geom_vline(xintercept = 0, lty = 2) +
labs(x= "Value", y= "Coefficient", title= "Coefficient Plot for Policy by State") +
theme_minimal()
