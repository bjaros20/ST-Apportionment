install.packages("tidyr")
install.packages("dplyr")
install.packages("did")
install.packages("tidyverse")
install.packages("lmtest")
library(readxl)
library(tidyr)
library(dplyr)
library(did)
library(tidyverse)
library(lmtest)
Census State and Local Data- Tax Foundation
# Census State and Local Data- Tax Foundation
install.packages("readxl")
install.packages("tidyr")
install.packages("dplyr")
install.packages("tidyverse")
install.packages("xlsx")
library(readxl)
library(tidyr)
library(dplyr)
library(tidyverse)
library(xlsx)
#Nebraska or "Direct Switchers DiD Approach"
#Run DiD with all the Direct Switchers (NE, MO, MS, CO, RI, ND, DE)
#Control Group is all States that Did not Switch by 2007.
#this includes: AK, HI, KS, NM, OK.  AL and MT between 2008-now became "Step
#-wise" switchers.  FL and MA had DWS over the whole period 1976-2022.
library(tidyr)
library(dplyr)
library(tidyverse)
# for robust standard error estimation
library(lmtest)
# To calculate correct vcov matrix with 2WFE
library(multiwayvcov)
# For a package way to do FE
library(plm)
#Fixest
install.packages("fixest")
library(fixest)
#Load Data Tables in R
install.packages("data.table")
# Get rate of change for tax bases and find elasticity of tax base w.r.t apportionment and rate changes.
#Redo Callaway and Sant'Anna From Summer
library(readxl)
library(tidyr)
library(dplyr)
library(did)
library(tidyverse)
library(lmtest)
library(caret)
library(ggplot2)
#New Directory
setwd("~/Documents/GitHub/ST_Apportionment/Rates_Of_Change")
#Create a loop for the bls employment results by state
#Load Packages
library(tidyr)
library(dplyr)
library(tidyverse)
library(lmtest)
library(ggplot2)
library(did) # for running DiD
library(plm)
library(lmtest)
library(synthdid)
library(fixest)
library(boot)
library(ggthemes)
# set seed
set.seed(26)
#JMP Directory
setwd("~/Documents/GitHub/ST-Apportionment/job_market_data")
filter_bls <-read.csv("bls_post.csv")
View(filter_bls)
#Create an industry vector for loop
# Create a vector with the specified column names
selected_columns <- c(
"Totalemploymentnumberofjobs",
"Wageandsalaryemployment",
"Proprietorsemployment",
"Farmproprietorsemployment",
"Nonfarmproprietorsemployment2",
"Farmemployment",
"Nonfarmemployment",
"Privatenonfarmemployment",
"Forestryfishingandrelatedactivities",
"Miningquarryingandoilandgasextraction",
"Utilities",
"Construction",
"Manufacturing",
"Wholesaletrade",
"Retailtrade",
"Transportationandwarehousing",
"Information",
"Financeandinsurance",
"Realestateandrentalandleasing",
"Professionalscientificandtechnicalservices",
"Managementofcompaniesandenterprises",
"Administrativeandsupportandwastemanagementandremediationservices",
"Educationalservices",
"Healthcareandsocialassistance",
"Artsentertainmentandrecreation",
"Accommodationandfoodservices",
"Otherservicesexceptgovernmentandgovernmententerprises",
"Governmentandgovernmententerprises",
"Federalcivilian",
"Military",
"Stateandlocal",
"Stategovernment",
"Localgovernment"
)
#rename GeoName column to State_Name
filter_bls <- filter_bls %>%
rename(State_Name = GeoName)
View(filter_bls)
write.csv(filter_bls,"bls_post.csv", row.names = FALSE)
filter_bls %>% select(-X)
write.csv(filter_bls,"bls_post.csv", row.names = FALSE)
filter_bls <-read.csv("bls_post.csv")
View(filter_bls)
filter_bls %>% select(-X)
View(filter_bls)
filt <-filter_bls %>% select(-X)
filter_bls <-filter_bls %>% select(-X)
write.csv(filter_bls,"bls_post.csv", row.names = FALSE)
filter_bls <- filter_bls %>%
rename(State_Name = GeoName)
View(filter_bls)
str(filter_bls)
#Create base dataframe that has nat_share as dependent variable.
Filter_frac <-filter_bls %>%
select(State_Acronym,year,year_effective,State_Name,Totalemploymentnumberofjobs,Post)
#Create base dataframe that has nat_share as dependent variable.
Filter_frac <-filter_bls %>%
select(State_Name,year,year_effective,State_Name,Totalemploymentnumberofjobs,Post)
filt_Corp <-Filter_frac
#Create State Dataframes
#create result list to store dataframe
result_list <- list()
# Make a copy of the original dataframe to work with
original_df <- filt_Corp
#counter variable, so as loop progresses, drops first state
counter <- 1
Filter_frac <-filter_bls %>%
select(State_Name,year,year_effective,Totalemploymentnumberofjobs,Post)
#Now create a BLS loop, loop through the selected vectors
filt_Corp <-Filter_frac
#Create State Dataframes
#create result list to store dataframe
result_list <- list()
# Make a copy of the original dataframe to work with
original_df <- filt_Corp
#counter variable, so as loop progresses, drops first state
counter <- 1
while (TRUE) {
#Reset to original each start
df <-filt_Corp
# Arrange by year_effective and select the first state for treatment
df <- df %>% arrange(year_effective)
#counter variable for running the loop
if(df$year_effective[counter] >= 2022) {break}
treatment_state <- df %>% slice(counter)
treatment_year <- treatment_state$year_effective
treatment_state_name <- treatment_state$State_Name
#filter out prior treated states, but keep no treatment states
#first half of filter keeps no treatment states in,
df <- df %>%
filter(is.na(year_effective) | is.na(State_Name) | year_effective >= treatment_year)
# removes states treated in same year
#the year_effective=treatment_year are filtered out if they are not 'treatment_state'
df <- df %>%
filter(is.na(year_effective) | (!(State_Name != treatment_state_name & year_effective == treatment_year)))
# Filter out rows with year <= 2 years after treatment_year
df <- df %>%
filter(year <= treatment_year + 2)
#filter out any states that get treated within 2 years of treatment
df <- df %>%
filter(is.na(year_effective) | (!(year_effective > treatment_year & year_effective<= treatment_year + 2)))
#filter out Ohio after treatment_year >=2012, because OH eliminates CI in 2014
df <- df %>%
filter(!(treatment_year >= 2012 & State_Name == "Ohio"))
# Store the dataframe for this treatment state
assign(treatment_state_name, df)
result_list[[treatment_state_name]] <- df
# Check if the treatment year is 2022 or greater, break
if (treatment_year >= 2022) {break}
#increment counter
counter <-counter + 1
#empty dataframe break
if (nrow(df) == 0) {break}
}
#Load Detrended, per capita, real revenue data, bls data
Rev <- read.csv("detrend_per_capita.csv")
Post <- Rev%>%
select(State_Name,Post,year,year_effective,State_Acronym)
bls <-read.csv("bls_NoID_complete.csv")
#left join eliminates USA and filters down to just 2001-2022
bls_merge2 <- bls %>%
left_join(Post, by = c("GeoName" = "State_Name", "year" = "year"))
filter_bls <-bls_merge2 %>%
select(-X)
View(filter_bls)
# Remove leading "X" from column names from the merge
colnames(filter_bls) <- gsub("^X", "", colnames(filter_bls))
#remove leading periods from spaces
colnames(filter_bls) <- gsub("^X|\\.+", "", colnames(filter_bls))
View(filter_bls)
#rename GeoName column to State_Name
filter_bls <- filter_bls %>%
rename(State_Name = GeoName)
View(filter_bls)
write.csv(filter_bls,"bls_post.csv", row.names = FALSE)
#Create base dataframe that has nat_share as dependent variable.
Filter_frac <-filter_bls %>%
select(State_Acronym,year,year_effective,State_Name,Totalemploymentnumberofjobs,Post)
#Now create a BLS loop, loop through the selected vectors
filt_Corp <-Filter_frac
#Create State Dataframes
#create result list to store dataframe
result_list <- list()
# Make a copy of the original dataframe to work with
original_df <- filt_Corp
#counter variable, so as loop progresses, drops first state
counter <- 1
#Create State Dataframes
#create result list to store dataframe
result_list <- list()
# Make a copy of the original dataframe to work with
original_df <- filt_Corp
#counter variable, so as loop progresses, drops first state
counter <- 1
while (TRUE) {
#Reset to original each start
df <-filt_Corp
# Arrange by year_effective and select the first state for treatment
df <- df %>% arrange(year_effective)
#counter variable for running the loop
if(df$year_effective[counter] >= 2022) {break}
treatment_state <- df %>% slice(counter)
treatment_year <- treatment_state$year_effective
treatment_state_name <- treatment_state$State_Name
#filter out prior treated states, but keep no treatment states
#first half of filter keeps no treatment states in,
df <- df %>%
filter(is.na(year_effective) | is.na(State_Acronym) | year_effective >= treatment_year)
# removes states treated in same year
#the year_effective=treatment_year are filtered out if they are not 'treatment_state'
df <- df %>%
filter(is.na(year_effective) | (!(State_Name != treatment_state_name & year_effective == treatment_year)))
# Filter out rows with year <= 2 years after treatment_year
df <- df %>%
filter(year <= treatment_year + 2)
#filter out any states that get treated within 2 years of treatment
df <- df %>%
filter(is.na(year_effective) | (!(year_effective > treatment_year & year_effective<= treatment_year + 2)))
#filter out Ohio after treatment_year >=2012, because OH eliminates CI in 2014
df <- df %>%
filter(!(treatment_year >= 2012 & State_Name == "Ohio"))
# Store the dataframe for this treatment state
assign(treatment_state_name, df)
result_list[[treatment_state_name]] <- df
# Check if the treatment year is 2022 or greater, break
if (treatment_year >= 2022) {break}
#increment counter
counter <-counter + 1
#empty dataframe break
if (nrow(df) == 0) {break}
}
View(Iowa)
#Reset to original each start
df <-filt_Corp
# Arrange by year_effective and select the first state for treatment
df <- df %>% arrange(year_effective)
#counter variable for running the loop
if(df$year_effective[counter] >= 2022) {break}
treatment_state <- df %>% slice(counter)
treatment_year <- treatment_state$year_effective
treatment_state_name <- treatment_state$State_Name
#filter out states with year_effective before 2001
df <- df %>%
filter(year_effective>=2001)
View(df)
#filter out prior treated states, but keep no treatment states
#first half of filter keeps no treatment states in,
df <- df %>%
filter(is.na(year_effective) | is.na(State_Acronym) | year_effective >= treatment_year)
# removes states treated in same year
#the year_effective=treatment_year are filtered out if they are not 'treatment_state'
df <- df %>%
filter(is.na(year_effective) | (!(State_Name != treatment_state_name & year_effective == treatment_year)))
# Filter out rows with year <= 2 years after treatment_year
df <- df %>%
filter(year <= treatment_year + 2)
#filter out any states that get treated within 2 years of treatment
df <- df %>%
filter(is.na(year_effective) | (!(year_effective > treatment_year & year_effective<= treatment_year + 2)))
#filter out Ohio after treatment_year >=2012, because OH eliminates CI in 2014
df <- df %>%
filter(!(treatment_year >= 2012 & State_Name == "Ohio"))
# Store the dataframe for this treatment state
assign(treatment_state_name, df)
result_list[[treatment_state_name]] <- df
# Check if the treatment year is 2022 or greater, break
if (treatment_year >= 2022) {break}
#Create State Dataframes
#create result list to store dataframe
result_list <- list()
# Make a copy of the original dataframe to work with
original_df <- filt_Corp
#counter variable, so as loop progresses, drops first state
counter <- 1
while (TRUE) {
#Reset to original each start
df <-filt_Corp
#filter out states with year_effective before 2001
df <- df %>%
filter(year_effective>=2001)
# Arrange by year_effective and select the first state for treatment
df <- df %>% arrange(year_effective)
#counter variable for running the loop
if(df$year_effective[counter] >= 2022) {break}
treatment_state <- df %>% slice(counter)
treatment_year <- treatment_state$year_effective
treatment_state_name <- treatment_state$State_Name
#filter out prior treated states, but keep no treatment states
#first half of filter keeps no treatment states in,
df <- df %>%
filter(is.na(year_effective) | is.na(State_Acronym) | year_effective >= treatment_year)
# removes states treated in same year
#the year_effective=treatment_year are filtered out if they are not 'treatment_state'
df <- df %>%
filter(is.na(year_effective) | (!(State_Name != treatment_state_name & year_effective == treatment_year)))
# Filter out rows with year <= 2 years after treatment_year
df <- df %>%
filter(year <= treatment_year + 2)
#filter out any states that get treated within 2 years of treatment
df <- df %>%
filter(is.na(year_effective) | (!(year_effective > treatment_year & year_effective<= treatment_year + 2)))
#filter out Ohio after treatment_year >=2012, because OH eliminates CI in 2014
df <- df %>%
filter(!(treatment_year >= 2012 & State_Name == "Ohio"))
# Store the dataframe for this treatment state
assign(treatment_state_name, df)
result_list[[treatment_state_name]] <- df
# Check if the treatment year is 2022 or greater, break
if (treatment_year >= 2022) {break}
#increment counter
counter <-counter + 1
#empty dataframe break
if (nrow(df) == 0) {break}
}
View(result_list)
# Initialize an empty list to store point estimates and statistics
point_estimate_list <- list()
# Loop over each dataframe in result_list
for (state_name in names(result_list)) {
# Access the dataframe
current_df <- result_list[[state_name]]
#Make the tibble from the result list a dataframe, easier for panel.matrics function
current_df <- as.data.frame(current_df)
#Drop states that have NA for ratio (like Alaska because no Income Tax)
current_df <- na.omit(current_df[, c("State_Acronym", "year", "Totalemploymentnumberofjobs", "Post")])
#eliminate Inf lines and the state that has them for estimation, like Ohio 2009-2013
states_with_inf <- current_df %>%
group_by(State_Acronym) %>%
filter(any(is.infinite(Totalemploymentnumberofjobs))) %>%
pull(State_Acronym) %>%
unique()
# Filter out those states from the dataframe
current_df <- current_df %>%
filter(!State_Acronym %in% states_with_inf)
# Create the panel matrices for sDiD using synthdid
current_sDiD <- panel.matrices(current_df, unit = "State_Acronym", time = "year", outcome = "Totalemploymentnumberofjobs", treatment = "Post")
# Calculate the synthetic difference-in-differences estimate
current_tau_hat <- synthdid_estimate(current_sDiD$Y, current_sDiD$N0, current_sDiD$T0)
se <- sqrt(vcov(current_tau_hat, method = 'placebo'))
# Calculate the t-statistic
t_statistic <- as.numeric(current_tau_hat) / se
# Calculate the p-value
p_value <- 2 * pt(abs(t_statistic), df = nrow(current_df) - 1, lower.tail = FALSE)
# Print the point estimate, confidence interval, t-statistic, and p-value
cat(sprintf('State: %s\n', state_name))
cat(sprintf('Point estimate: %1.5f\n', current_tau_hat))
cat(sprintf('95%% CI (%1.4f, %1.4f)\n', current_tau_hat - 1.96 * se, current_tau_hat + 1.96 * se))
cat(sprintf('t-statistic: %1.3f\n', t_statistic))
cat(sprintf('p-value: %1.4f\n', p_value))
# Summary statistics
#  print(summary(current_tau_hat))
}
str(filter_bls)
#Summary Statistics for otalemploymentnumberofjobs
summary_stats <- filter_bls %>%
filter(!is.na(Totalemploymentnumberofjobs) & is.finite(Totalemploymentnumberofjobs)) %>%  # Remove rows with NA in nat_share
group_by(State_Name) %>%
summarize(
mean = mean(Totalemploymentnumberofjob, na.rm = TRUE),
median = median(Totalemploymentnumberofjob, na.rm = TRUE),
IQR = IQR(Totalemploymentnumberofjob, na.rm = TRUE),
min = min(Totalemploymentnumberofjob, na.rm = TRUE),
max = max(Totalemploymentnumberofjob, na.rm = TRUE)
)
summary_stats <- filter_bls %>%
filter(!is.na(Totalemploymentnumberofjobs) & is.finite(Totalemploymentnumberofjobs)) %>%  # Remove rows with NA in nat_share
group_by(State_Name) %>%
summarize(
mean = mean(Totalemploymentnumberofjobs, na.rm = TRUE),
median = median(Totalemploymentnumberofjobs, na.rm = TRUE),
IQR = IQR(Totalemploymentnumberofjobs, na.rm = TRUE),
min = min(Totalemploymentnumberofjobs, na.rm = TRUE),
max = max(Totalemploymentnumberofjobs, na.rm = TRUE)
)
print(summary_stats,n = nrow(summary_stats))
#Simple Reg (w/o rate) (a) (i)
Simple_reg <- lm(Totalemploymentnumberofjobs ~ Post + factor(year) + factor(state_name), filter_bls)
summary(Simple_reg)
# Remove rows with any missing values in the relevant columns
filter_bls_clean <- filter_bls %>%
filter(!is.na(Totalemploymentnumberofjobs) & !is.na(Post) &
!is.na(year) & !is.na(state_name))
#Simple Reg (w/o rate) (a) (i)
Simple_reg <- lm(Totalemploymentnumberofjobs ~ Post + factor(year) + factor(state_name), data = filter_bls_clean)
levels(as.factor(filter_bls$state_name))
levels(as.factor(filter_bls$year))
Simple_reg <- lm(Totalemploymentnumberofjobs ~ Post + factor(year) + factor(State_Name), data = filter_bls_clean)
summary(Simple_reg)
# I can try and break those coefficients up by state
# Interaction Reg (with interaction between Post and state)
Interaction_reg <- lm(Totalemploymentnumberofjobs~ Post * factor(State_Name) + factor(year), data = filter_bls_clean)
summary(Interaction_reg)
View(filter_bls_clean)
#Simple Reg (w/o rate) (a) (i)
Man_reg <- lm(Manufacturing ~ Post + factor(year) + factor(State_Name), data = filter_bls_clean)
filter_bls_man <- filter_bls %>%
filter(!is.na(Manufacturing) & !is.na(Post) &
!is.na(year) & !is.na(state_name))
Man_reg <- lm(Manufacturing ~ Post + factor(year) + factor(State_Name), data = filter_bls_man)
filter_bls_man <- filter_bls %>%
filter(!is.na(Manufacturing) & !is.na(Post) &
!is.na(year) & !is.na(state_name))
View(filter_bls_man)
filter_bls_man <- filter_bls %>%
filter(!is.na(Manufacturing) & Manufacturing != "(D)" &
!is.na(Post) & !is.na(year) & !is.na(state_name))
Man_reg <- lm(Manufacturing ~ Post + factor(year) + factor(State_Name), data = filter_bls_man)
summary(Man_reg)
IntMan_reg <- lm(Manufacturing~ Post * factor(State_Name) + factor(year), data = filter_bls_man)
summary(IntMan_reg)
#Salaried workers- Wageandsalaryemployment
filter_bls_sal <- filter_bls_sal %>%
filter(!is.na(Wageandsalaryemployment) & Wageandsalaryemployment != "(D)" &
!is.na(Post) & !is.na(year) & !is.na(state_name))
#Salaried workers- Wageandsalaryemployment
filter_bls_sal <- filter_bls %>%
filter(!is.na(Wageandsalaryemployment) & Wageandsalaryemployment != "(D)" &
!is.na(Post) & !is.na(year) & !is.na(state_name))
sal_reg <- lm(Wageandsalaryemployment ~ Post + factor(year) + factor(State_Name), data = filter_bls_sal)
summary(sal_reg)
Intsal_reg <- lm(Wageandsalaryemployment~ Post * factor(State_Name) + factor(year), data = filter_bls_sal)
summary(Intsal_reg)
#detrend employment
library(pracma)
safe_detrend <- function(x) {
if (length(x) > 1) {
return(pracma::detrend(x, tt = "linear"))
} else {
return(rep(NA, length(x)))  # Return NA for groups that can't be detrended
}
}
bls_detrend <- filter_bls %>%
filter(!is.na(Wageandsalaryemployment) & Wageandsalaryemployment != "(D)"
&!is.na(Manufacturing) & Manufacturing != "(D)" &!is.na(Totalemploymentnumberofjobs)&
!is.na(Post) & !is.na(year) & !is.na(state_name))%>%
group_by(State_Acronym) %>%
mutate(de_tot_jobs = safe_detrend(Totalemploymentnumberofjobs))%>%
mutate(de_man_jobs = safe_detrend(Manufacturing)) %>%
mutate(de_salary = safe_detrend(Wageandsalaryemployment))
bls_detrend <- filter_bls %>%
filter(!is.na(Wageandsalaryemployment) & Wageandsalaryemployment != "(D)" &
!is.na(Manufacturing) & Manufacturing != "(D)" &
!is.na(Totalemploymentnumberofjobs) & !is.na(Post) &
!is.na(year) & !is.na(state_name)) %>%
mutate(Totalemploymentnumberofjobs = as.numeric(Totalemploymentnumberofjobs),
Manufacturing = as.numeric(Manufacturing),
Wageandsalaryemployment = as.numeric(Wageandsalaryemployment)) %>%
group_by(State_Acronym) %>%
mutate(de_tot_jobs = safe_detrend(Totalemploymentnumberofjobs),
de_man_jobs = safe_detrend(Manufacturing),
de_salary = safe_detrend(Wageandsalaryemployment)) %>%
ungroup()
View(bls_detrend)
write(bls_detrend,"bls_detrend.csv")
write.csv(bls_detrend,"bls_detrend.csv", row.names=FALSE)
#Estimate these regressions via Simple Regression
Simple_reg_de<- lm(de_tot_jobs ~ Post + factor(year) + factor(State_Name), data = bls_detrend)
summary(Simple_reg_de)
# I can try and break those coefficients up by state
# Interaction Reg (with interaction between Post and state)
Interaction_reg_de<- lm(de_tot_jobs~ Post * factor(State_Name) + factor(year), data = bls_detrend)
summary(Interaction_reg_de)
Man_reg_de <-lm(de_man_jobs ~ Post + factor(year)+factor(State_Name),data=bls_detrend)
summary(Man_reg_de)
Int_man_reg_de <- lm(de_man_jobs ~Post * factor(State_Name) + factor(year), data = bls_detrend)
Summary(Int_man_reg_de)
summary(Int_man_reg_de)
#Salary detrended
Sal_reg_De <-lm(de_sal_jobs ~ Post + factor(year)+factor(State_Name),data=bls_detrend)
#Salary detrended
Sal_reg_De <-lm(de_salary ~ Post + factor(year)+factor(State_Name),data=bls_detrend)
summary(Sal_reg_De)
int_sal_reg_de <- lm(de_salary Post * factor(State_Name) + factor(year), data = bls_detrend)
int_sal_reg_de <- lm(de_salary~Post * factor(State_Name) + factor(year), data = bls_detrend)
summary(int_sal_reg_de)
