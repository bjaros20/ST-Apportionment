#Attempt to Get Revenue in R
install.packages("readxl")
install.packages("tidyr")
install.packages("dplyr")
install.packages("did")
install.packages("tidyverse")
install.packages("lmtest")
library(readxl)
library(tidyr)
library(dplyr)
library(did)
library(tidyverse)
library(lmtest)
Census State and Local Data- Tax Foundation
# Census State and Local Data- Tax Foundation
install.packages("readxl")
install.packages("tidyr")
install.packages("dplyr")
install.packages("tidyverse")
install.packages("xlsx")
library(readxl)
library(tidyr)
library(dplyr)
library(tidyverse)
library(xlsx)
#Nebraska or "Direct Switchers DiD Approach"
#Run DiD with all the Direct Switchers (NE, MO, MS, CO, RI, ND, DE)
#Control Group is all States that Did not Switch by 2007.
#this includes: AK, HI, KS, NM, OK.  AL and MT between 2008-now became "Step
#-wise" switchers.  FL and MA had DWS over the whole period 1976-2022.
library(tidyr)
library(dplyr)
library(tidyverse)
# for robust standard error estimation
library(lmtest)
# To calculate correct vcov matrix with 2WFE
library(multiwayvcov)
# For a package way to do FE
library(plm)
#Fixest
install.packages("fixest")
library(fixest)
#Load Data Tables in R
install.packages("data.table")
# Get rate of change for tax bases and find elasticity of tax base w.r.t apportionment and rate changes.
#Redo Callaway and Sant'Anna From Summer
library(readxl)
library(tidyr)
library(dplyr)
library(did)
library(tidyverse)
library(lmtest)
library(caret)
library(ggplot2)
#New Directory
setwd("~/Documents/GitHub/ST_Apportionment/Rates_Of_Change")
#Load Packages
library(readxl)
library(tidyr)
library(dplyr)
library(tidyverse)
library(lmtest)
library(ggplot2)
library(did) # for running DiD
library(sjlabelled) # req by https://rpubs.com/phle/r_tutorial_difference_in_differences
library(ggrepel) # req by ^
library(scales) # req by ^
library(ggpubr) # req by ^
library(plm)
library(lmtest)
library(lubridate) #convert date to year
# set seed
set.seed(26)
#JMP Directory
setwd("~/Documents/GitHub/ST-Apportionment/job_market_data")
#Load the df from last session, and run estimation for per capita with detrended data.
Rev <- read.csv("real_per_capita_df.csv")
View(Rev)
#Create a dataframe with just 2007 states
treated_states <- Rev %>%
filter(year_effective==2007)
#create df for control group
control_states <- Rev %>%
filter(year_effective >=2011 | is.na(year_effective))
#Create dataframe with states in control_states
states_1df <- control_states %>%
distinct(State_Acronym)
print(states_1df)
states_2df <- treated_states %>%
distinct(State_Acronym)
# find mean of control_States, pre & post
control_pre <-control_states %>%
filter(year <= 2007) %>%
summarize(avg_outcome = mean(real_totRev_capita, na.rm= TRUE))
control_post <-control_states %>%
filter(year >2007 & year<2011) %>%
summarize(avg_outcome = mean(real_totRev_capita, na.rm= TRUE))
# calculate averages for treatment group
treatment_pre <- treated_states %>%
filter(year <= 2007) %>%
summarize(avg_outcome = mean(real_totRev_capita, na.rm = TRUE))
treatment_post <- treated_states %>%
filter(year >2007 & year<2011) %>%
summarise(avg_outcome = mean(real_totRev_capita, na.rm = TRUE))
View(treatment_post)
View(treatment_pre)
View(treated_states)
View(control_pre)
View(control_states)
install.packages("pracma")
library(pracma)
Rev2 <- Rev %>%
group_by(State_Acronym) %>%
mutate(detrended_RTR_capita = detrend(real_totRev_capita,tt="linear")) %>%
mutate(detrended_CIT_capita = detrend(real_cit_capita,tt="linear")) %>%
ungroup()
Rev2 <- Rev %>%
group_by(State_Acronym) %>%
mutate(detrended_RTR_capita = detrend(real_totRev_capita,tt="linear")) %>%
ungroup()
safe_detrend <- function(x) {
if (length(x) > 1) {
return(detrend(x, tt = "linear"))
} else {
return(rep(NA, length(x)))  # Return NA for groups that can't be detrended
}
}
Rev2 <- Rev %>%
group_by(State_Acronym) %>%
mutate(detrended_RTR_capita = safe_detrend(real_totRev_capita),
detrended_CIT_capita = safe_detrend(real_cit_capita)) %>%
ungroup()
View(Rev2)
str(Rev2)
#Create a dataframe with just 2007 states
treated_states <- Rev2 %>%
filter(year_effective==2007)
#create df for control group
control_states <- Rev2 %>%
filter(year_effective >=2011 | is.na(year_effective))
#Create dataframe with states in control_states
states_1df <- control_states %>%
distinct(State_Acronym)
states_2df <- treated_states %>%
distinct(State_Acronym)
# find mean of control_States, pre & post
control_pre <-control_states %>%
filter(year <= 2007) %>%
summarize(avg_outcome = mean(detrended_RTR_capita, na.rm= TRUE))
control_post <-control_states %>%
filter(year >2007 & year<2011) %>%
summarize(avg_outcome = mean(detrended_RTR_capita, na.rm= TRUE))
# calculate averages for treatment group
treatment_pre <- treated_states %>%
filter(year <= 2007) %>%
summarize(avg_outcome = mean(detrended_RTR_capita, na.rm = TRUE))
treatment_post <- treated_states %>%
filter(year >2007 & year<2011) %>%
summarise(avg_outcome = mean(detrended_RTR_capita, na.rm = TRUE))
# Calculate differences
control_diff <- control_post$avg_outcome - control_pre$avg_outcome
treatment_diff <- treatment_post$avg_outcome - treatment_pre$avg_outcome
# Calculate Difference-in-Differences
did_estimate <- treatment_diff - control_diff
# Print the DiD estimate
did_estimate
#[1] -131.2836
average_c <- control_states %>%
group_by(year) %>%
filter(!is.na(detrended_RTR_capita)) %>%
summarise(average_TOTLTX_c = mean(detrended_RTR_capita),
std_err_c = sd(detrended_RTR_capita) / sqrt(n()))
# Calculate average detrended_RTR_capita by year for treated states along with standard error
average_t <- treated_states %>%
group_by(year) %>%
filter(!is.na(detrended_RTR_capita)) %>%
summarise(average_TOTLTX_t = mean(detrended_RTR_capita),
std_err_t = sd(detrended_RTR_capita) / sqrt(n()))
# Merge the two dataframes by year
average_df <- merge(average_c, average_t, by = "year", all = TRUE)
# Create the plot, standard bar plot with standard error bars
ggplot(average_df, aes(x = year)) +
geom_point(aes(y = average_TOTLTX_c, color = "Control Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_c, ymin = average_TOTLTX_c - std_err_c, ymax = average_TOTLTX_c + std_err_c, color = "Control Group"), width = 0.2) +
geom_point(aes(y = average_TOTLTX_t, color = "Treatment Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_t, ymin = average_TOTLTX_t - std_err_t, ymax = average_TOTLTX_t + std_err_t, color = "Treatment Group"), width = 0.2) +
geom_vline(xintercept = 2007, linetype = "dashed", color = "black", size = 1) +
labs(title = "Average Real Total Tax Revenue per Capita by Year for Control and Treatment Groups- DETRENDED",
x = "Year",
y = "Average Real Total Tax Revenue per Capita") +
scale_color_manual(values = c("Control Group" = "blue", "Treatment Group" = "red"),
labels = c("Control Group" = "Group c", "Treatment Group" = "Group t")) +
guides(color = guide_legend(title = "Groups")) +
theme_minimal()
# Create the plot, standard bar plot with standard error bars
ggplot(average_df, aes(x = year)) +
geom_point(aes(y = average_TOTLTX_c, color = "Control Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_c, ymin = average_TOTLTX_c - std_err_c, ymax = average_TOTLTX_c + std_err_c, color = "Control Group"), width = 0.2) +
geom_point(aes(y = average_TOTLTX_t, color = "Treatment Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_t, ymin = average_TOTLTX_t - std_err_t, ymax = average_TOTLTX_t + std_err_t, color = "Treatment Group"), width = 0.2) +
geom_vline(xintercept = 2007, linetype = "dashed", color = "black", size = 1) +
labs(title = "Average Real Total Tax Revenue per Capita by Year - DETRENDED",
x = "Year",
y = "Average Real Total Tax Revenue per Capita") +
scale_color_manual(values = c("Control Group" = "blue", "Treatment Group" = "red"),
labels = c("Control Group" = "Group c", "Treatment Group" = "Group t")) +
guides(color = guide_legend(title = "Groups")) +
theme_minimal()
# Now modify the plot to only have years 2004-2010
ggplot(average_df, aes(x = year)) +
geom_point(aes(y = average_TOTLTX_c, color = "Control Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_c, ymin = average_TOTLTX_c - std_err_c, ymax = average_TOTLTX_c + std_err_c, color = "Control Group"), width = 0.2) +
geom_point(aes(y = average_TOTLTX_t, color = "Treatment Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_t, ymin = average_TOTLTX_t - std_err_t, ymax = average_TOTLTX_t + std_err_t, color = "Treatment Group"), width = 0.2) +
geom_vline(xintercept = 2007, linetype = "dashed", color = "black", size = 1) +
labs(title = "Average Real Total Tax Revenue per Capita by Year -DETRENDED",
x = "Year",
y = "Average Real Total Tax Revenue per Capita") +
scale_color_manual(values = c("Control Group" = "blue", "Treatment Group" = "red"),
labels = c("Control Group" = "Group c", "Treatment Group" = "Group t")) +
guides(color = guide_legend(title = "Groups")) +
xlim(2004, 2010) +
theme_minimal()
#save detrended dataframe
write.csv(Rev2,"detrend_per_capita.csv")
# find mean of control_States, pre & post
control_pre <-control_states %>%
filter(year <= 2007) %>%
summarize(avg_outcome = mean(detrended_CIT_capita, na.rm= TRUE))
control_post <-control_states %>%
filter(year >2007 & year<2011) %>%
summarize(avg_outcome = mean(detrended_CIT_capita, na.rm= TRUE))
# calculate averages for treatment group
treatment_pre <- treated_states %>%
filter(year <= 2007) %>%
summarize(avg_outcome = mean(detrended_CIT_capita, na.rm = TRUE))
treatment_post <- treated_states %>%
filter(year >2007 & year<2011) %>%
summarise(avg_outcome = mean(detrended_CIT_capita, na.rm = TRUE))
# Calculate differences
control_diff <- control_post$avg_outcome - control_pre$avg_outcome
treatment_diff <- treatment_post$avg_outcome - treatment_pre$avg_outcome
# Calculate Difference-in-Differences
did_estimate <- treatment_diff - control_diff
# Print the DiD estimate
did_estimate
# Calculate average detrended_CIT_capita by year for control group along with standard error
average_c <- control_states %>%
group_by(year) %>%
filter(!is.na(detrended_CIT_capita)) %>%
summarise(average_TOTLTX_c = mean(detrended_CIT_capita),
std_err_c = sd(detrended_CIT_capita) / sqrt(n()))
# Calculate average detrended_CIT_capita by year for treated states along with standard error
average_t <- treated_states %>%
group_by(year) %>%
filter(!is.na(detrended_CIT_capita)) %>%
summarise(average_TOTLTX_t = mean(detrended_CIT_capita),
std_err_t = sd(detrended_CIT_capita) / sqrt(n()))
# Merge the two dataframes by year
average_df <- merge(average_c, average_t, by = "year", all = TRUE)
# Create the plot, standard bar plot with standard error bars
ggplot(average_df, aes(x = year)) +
geom_point(aes(y = average_TOTLTX_c, color = "Control Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_c, ymin = average_TOTLTX_c - std_err_c, ymax = average_TOTLTX_c + std_err_c, color = "Control Group"), width = 0.2) +
geom_point(aes(y = average_TOTLTX_t, color = "Treatment Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_t, ymin = average_TOTLTX_t - std_err_t, ymax = average_TOTLTX_t + std_err_t, color = "Treatment Group"), width = 0.2) +
geom_vline(xintercept = 2007, linetype = "dashed", color = "black", size = 1) +
labs(title = "Average Real CIT Tax Revenue per Capita by Year - DETRENDED",
x = "Year",
y = "Average Real CIT Tax Revenue per Capita") +
scale_color_manual(values = c("Control Group" = "blue", "Treatment Group" = "red"),
labels = c("Control Group" = "Group c", "Treatment Group" = "Group t")) +
guides(color = guide_legend(title = "Groups")) +
theme_minimal()
# Now modify the plot to only have years 2004-2010
ggplot(average_df, aes(x = year)) +
geom_point(aes(y = average_TOTLTX_c, color = "Control Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_c, ymin = average_TOTLTX_c - std_err_c, ymax = average_TOTLTX_c + std_err_c, color = "Control Group"), width = 0.2) +
geom_point(aes(y = average_TOTLTX_t, color = "Treatment Group"), size = 3) +
geom_errorbar(aes(y = average_TOTLTX_t, ymin = average_TOTLTX_t - std_err_t, ymax = average_TOTLTX_t + std_err_t, color = "Treatment Group"), width = 0.2) +
geom_vline(xintercept = 2007, linetype = "dashed", color = "black", size = 1) +
labs(title = "Average Real CIT Tax Revenue per Capita by Year -DETRENDED",
x = "Year",
y = "Average Real CIT Tax Revenue per Capita") +
scale_color_manual(values = c("Control Group" = "blue", "Treatment Group" = "red"),
labels = c("Control Group" = "Group c", "Treatment Group" = "Group t")) +
guides(color = guide_legend(title = "Groups")) +
xlim(2004, 2010) +
theme_minimal()
